==================
Ansible-LegacyRole
==================

はじめに
========

| 本書では、Ansible driverのLegacyRole機能および操作方法について説明します。

Ansible-LegacyRole概要
======================

| Legacyモードと同じく、Ansible標準の機能を用いて各種ホストへ設定を投入します。
| 構築コードをパッケージとして登録し、作業パターンをRoleの組み合わせで構成します。
| 製品部門などが提供するRoleパッケージを用いて、製品のインストール、環境構築などを行う際に使われることを想定します。

Ansible-LegacyRole メニュー構成
===============================

| 本章では、Ansible-LegacyRoleのメニュー構成について説明します。

メニュー/画面一覧
-----------------

1. | **基本コンソールのメニュー**

| Ansible-LegacyRoleで利用する 基本コンソールのメニュー一覧を以下に記述します。

.. include:: ../../include/ansible_option_basic-console-menu.rst

|

2. | **Ansible共通のメニュー**

.. include:: ../../include/ansible_option_ansible-common-console-menu.rst

.. tip:: | ※1 非表示メニューは、内部処理で使用するメニューです。
   | ITAをインストールした状態では表示されないメニューに設定されています。
   | 非表示メニューを表示するには、:menuselection:`管理コンソール --> ロール・メニュー紐付管理` で各メニューの復活処理を行います。詳細は「 :doc:`../it_automation_base/management_console` 」を参照してください。
   | 内部処理で使用するメニューには、登録を行わないようにしてください。

|

3. | **Ansible-LegacyRoleのメニュー**

| Ansible-LegacyRoleのメニュー一覧を以下に記述します。

.. list-table::  Ansible-LegacyRole メニュー/画面一覧
   :widths: 20 30 80
   :header-rows: 1
   :align: left

   * - No
     - メニュー・画面
     - 説明
   * - 1
     - Movement一覧
     - Movementの一覧を管理します。
   * - 2
     - ロールパッケージ管理
     - ロールパッケージを管理します。
   * - 3
     - Movement-ロール紐付
     - Movementでインクルードするロールパッケージを管理します。
   * - 4
     - 変数ネスト管理
     - 多段変数が繰返配列で構成されている場合の最大繰返配列数を管理します。
   * - 5
     - 代入値自動登録設定
     - パラメータシートに登録されているオぺレーションとホスト毎の項目値を紐付けるMovementと変数を管理します。
   * - 6
     - 作業実行
     - 作業実行するMovementとオペレーションを選択し実行を指示します。
   * - 7
     - 作業管理
     - 作業実行履歴を管理します。
   * - 8
     - 作業状態確認
     - 作業実行状態を表示します。
   * - 9
     - 作業対象ホスト
     - 作業実行毎の作業対象ホストを表示します。
   * - 10
     - 代入値管理
     - 作業実行毎の変数の具体値を表示します。
   * - 11
     - ロール名管理 （※1）
     - ロールパッケージ管理にアップロードしたロールパッケージファイル「zip」内に登録されているロール名とロールパッケージの紐付を閲覧できます。
   * - 12
     - Movement-変数紐付 （※1）
     - Movementで使用している変数を管理します。
   * - 13
     - 多段変数メンバー管理 （※1）
     - ロールパッケージ管理にアップロードしたロールパッケージファイル「zip」内のデフォルト変数定義ファイルやITA readmeファイルで定義している多段変数の構造を管理します。
   * - 14
     - 多段変数配列組合せ管理 （※1）
     - ロールパッケージ管理にアップロードしたロールパッケージファイル「zip」内のデフォルト変数定義ファイルやITA readmeファイルで定義している多段変数配列組合せを管理します。

.. tip:: | ※1 非表示メニューは、内部処理で使用するメニューです。
   | ITAをインストールした状態では表示されないメニューに設定されています。
   | 非表示メニューを表示するには、:menuselection:`管理コンソール --> ロール・メニュー紐付管理` で各メニューの復活処理を行います。詳細は「 :doc:`../it_automation_base/management_console` 」を参照してください。
   | 内部処理で使用するメニューには、登録を行わないようにしてください。


Ansible-LegacyRole利用手順
==========================

| Ansible-LegacyRoleの利用手順について説明します。

Ansible-LegacyRoleの作業フロー
------------------------------

| 以下は、Ansible-LegacyRoleで作業を実行するまでの流れです。

-  **作業フロー詳細と参照先**

   #. | **作業対象への接続情報を登録**
      | :menuselection:`Ansible共通 --> 機器一覧` から、作業対象への接続情報を登録します。
      | 詳細は「 :ref:`ansible_common_device_list` 」を参照してください。

   #. | **オペレーション名の登録**
      | :menuselection:`基本コンソール --> オペレーション一覧` から、作業用のオペレーション名を登録します。
      | 詳細は「 :ref:`basic_console_operation` 」を参照してください。

   #. | **Ansible Automation Controllerホスト情報を登録（必要に応じて実施）**
      | :menuselection:`Ansible共通 --> Ansible Automation Controllerホスト一覧` から、Ansible Automation Controllerのホスト情報を登録します。
      | 詳細は「 :ref:`ansible_common_ansible_automation_controller_hosts` 」を参照してください。

   #. | **インターフェース情報の登録**
      | :menuselection:`Ansible共通 --> インターフェース情報` から、Ansible Core、Ansible Automation Controllerのどちらを実行エンジンにするかを選択し、実行エンジンのサーバへの接続情報を登録します。
      | 詳細は「 :ref:`ansible_common_interface_information` 」を参照してください。

   #. | **Movementの登録**
      | :menuselection:`Ansible-LegacyRole --> Movement一覧` から、作業用のMovementを登録します。
      | 詳細は「 :ref:`ansible_legacyrole_movement_list` 」を参照してください。

   #. | **ロールパッケージの登録**
      | :menuselection:`Ansible-LegacyRole --> ロールパッケージ管理` から、作業で使用するロールパッケージを登録します。
      | 詳細は「 :ref:`ansible_legacyrole_role_package_list` 」を参照してください。

   #. | **グローバル変数の登録（必要に応じて実施）**
      | :menuselection:`Ansible共通 --> グローバル変数管理` から、ロールパッケージ内で使用するグローバル変数を登録します。
      | 詳細は「 :ref:`ansible_common_global_variable_list` 」を参照してください。

   #. | **テンプレートファイルの登録（必要に応じて実施）**
      | :menuselection:`Ansible共通 --> テンプレート管理` から、ロールパッケージ内で使用するテンプレートファイルとテンプレート埋込変数を登録します。
      | 詳細は「 :ref:`ansible_common_template_list` 」を参照してください。

   #. | **ファイル素材の登録（必要に応じて実施）**
      | :menuselection:`Ansible共通 --> ファイル管理` から、ロールパッケージ内で使用するファイル素材とファイル埋込変数を登録します。
      | 詳細は「 :ref:`ansible_common_file_list` 」を参照してください。

   #. | **管理対象外変数の登録（必要に応じて実施）**
      | :menuselection:`Ansible共通 --> 管理対象外変数リスト` から、変数抜出対象の資材から抜出した変数で、 :menuselection:`Ansible-LegacyRole --> 代入値自動登録` の :menuselection:`Movement名:変数名` に表示したくない変数を登録します。
      | 詳細は「 :ref:`ansible_common_unmanaged_var_list` 」を参照してください。

   #. | **Movementにロールパッケージを登録**
      | :menuselection:`Ansible-LegacyRole --> Movement-ロール紐付` から、登録したMovementでインクルードするロールパッケージを登録します。
      | 詳細は「 :ref:`ansible_legacyrole_movement_details` 」を参照してください。

   #. | **多段変数の最大繰返数を登録（必要に応じて実施）**
      | :menuselection:`Ansible-LegacyRole --> 変数ネスト管理` から、多段変数で配列定義されているメンバー変数の配列の最大繰返数を登録します。
      | 詳細は「 :ref:`ansible_legacyrole_nested_variable_list` 」を参照してください。

   #. | **パラメータシートの作成**
      | :menuselection:`パラメータシート作成・定義` から、作業対象の設定に使用するデータを登録するためのパラメータシートを作成します。
      | 詳細は「 :doc:`../create_param/menu_creation` 」を参照してください。

   #. | **パラメータシートにデータを登録**
      | 前項で作成したパラメータシートから、作業対象の設定に使用するデータを登録します。
      | 詳細は「 :doc:`../create_param/menu_creation` 」を参照してください。

   #. | **代入値自動登録設定**
      | :menuselection:`Ansible-LegacyRole --> 代入値自動登録設定` から、パラメータシートに登録されているオペレーションとホスト毎の項目の設定値と、Movementの変数を紐付けます。
      | 詳細は「 :ref:`ansible_legacyrole_substitution_value_auto_registration_setting` 」を参照してください。

   #. | **作業実行**
      | :menuselection:`Ansible-LegacyRole --> 作業実行` から、Movementとオペレーションを選択し作業の実行を行います。
      | 詳細は「 :ref:`ansible_legacyrole_execution` 」を参照してください。

   #. | **作業状態確認**
      | :menuselection:`Ansible-LegacyRole --> 作業状態確認` から、実行した作業の状態をリアルタイムで閲覧できます。また、作業の緊急停止や、実行ログ、エラーログを監視することができます。
      | 詳細は「 :ref:`ansible_legacyrole_check_operation_status` 」を参照してください。

   #. | **作業履歴確認**
      | :menuselection:`Ansible-LegacyRole --> 作業管理` から、実行した作業の一覧が表示され履歴が確認できます。
      | 詳細は「 :ref:`ansible_legacyrole_execution_list` 」を参照してください。


Ansible-LegacyRole メニュー操作方法説明
=======================================

| 本章では、Ansible-LegacyRoleで利用するメニューについて説明します。


基本コンソール
--------------

| 基本コンソールについての操作は「 :doc:`../it_automation_base/basic_console` 」を参照してください。


Ansible共通
-----------

| Ansible共通についての操作は「 :doc:`./ansible_common` 」を参照してください。


Ansible-LegacyRole
------------------

| 本節では、Ansible-LegacyRoleでの操作について記載します。

.. _ansible_legacyrole_movement_list:

Movement一覧
~~~~~~~~~~~~

#. | Movement情報のメンテナンス（閲覧/登録/更新/廃止）を行います。

   .. figure:: /images/ja/ansible-legacyrole/movement_list/movement_list.png
      :width: 800px
      :alt: サブメニュー画面（Movement一覧）

      サブメニュー画面（Movement一覧）

#. | :guilabel:`登録` ボタンより、Movement情報の登録を行います。

   .. figure:: /images/ja/ansible-legacyrole/movement_list/registration_movement_list.gif
      :width: 800px
      :alt: 登録画面（Movement一覧）

      登録画面（Movement一覧）


#. | 登録画面の項目一覧は以下のとおりです。

   .. table:: 登録画面項目一覧（Movement一覧）
      :align: left

      +-----------------------------------+-------------------------------------------------------------------------+-----------+--------------+-------------------+
      | 項目                              | 説明                                                                    | 入力必須  | 入力方法     | 制約事項          |
      |                                   |                                                                         |           |              |                   |
      |                                   |                                                                         |           |              |                   |
      +===================================+=========================================================================+===========+==============+===================+
      | MovementID                        | 登録時に自動採番した36桁の文字列が表示されます。                        | ー        | 自動入力     | ー                |
      +-----------------------------------+-------------------------------------------------------------------------+-----------+--------------+-------------------+
      | Movement名                        | Movementの名称を入力します。                                            | ○         | 手動入力     | 最大長255バイト   |
      +-----------------------------------+-------------------------------------------------------------------------+-----------+--------------+-------------------+
      | 遅延タイマー                      | Movementの実行が指定期間遅延した場合に :menuselection:`Ansible-\        | ー        | 手動入力     | 0～2,147,483,647  |
      |                                   | LegacyRole --> 作業状態確認` の :menuselection:`ステータス` を\         |           |              |                   |
      |                                   | 「実行中（遅延）」として警告表示したい場合に指定期間（1～）を\          |           |              |                   |
      |                                   | 入力します。（単位:分）                                                 |           |              |                   |
      |                                   |                                                                         |           |              |                   |
      |                                   | 未入力の場合は警告表示しません。                                        |           |              |                   |
      +-----------------+-----------------+-------------------------------------------------------------------------+-----------+--------------+-------------------+
      | Ansible利用情報 | ホスト指定形式  | IPアドレスで表現しないホストを指定したい\                               | ○         | リスト選択   | 説明欄記載のと\   |
      |                 |                 | 場合に「ホスト名」を選択します。                                        |           |              | おり。            |
      |                 |                 |                                                                         |           |              |                   |
      |                 +-----------------+-------------------------------------------------------------------------+-----------+--------------+-------------------+
      |                 | WinRM接続       | 作業対象がWindowsServerの場合に\                                        | ー        | リスト選択   | 説明欄記載のと\   |
      |                 |                 | 「True」を選択します。                                                  |           |              | おり。            |
      |                 +-----------------+-------------------------------------------------------------------------+-----------+--------------+-------------------+
      |                 | ヘッダー\       | ITAが自動生成する親Playbookの先頭からroles\                             | ー        | 手動入力     | 最大長4000バイト  |
      |                 | セクション ※1   | セクションまでのセクションを編集します。                                |           |              |                   |
      |                 |                 |                                                                         |           |              |                   |
      |                 |                 | 未入力の場合は以下を適用します。                                        |           |              |                   |
      |                 |                 |                                                                         |           |              |                   |
      |                 |                 | .. code-block:: yaml                                                    |           |              |                   |
      |                 |                 |                                                                         |           |              |                   |
      |                 |                 |    - hosts: all                                                         |           |              |                   |
      |                 |                 |      remote_user: "{{ __loginuser__ }}"                                 |           |              |                   |
      |                 |                 |      gather_facts: no                                                   |           |              |                   |
      |                 |                 |      become: yes                                                        |           |              |                   |
      |                 |                 |      # winrm接続の場合は become: yesは適用しません。                    |           |              |                   |
      |                 |                 |                                                                         |           |              |                   |
      |                 |                 | 各パラメータ値を変数で記述することも出来ます。                          |           |              |                   |
      |                 |                 |                                                                         |           |              |                   |
      |                 |                 | .. code-block:: yaml                                                    |           |              |                   |
      |                 |                 |                                                                         |           |              |                   |
      |                 |                 |     become_user: '{{△vvv△}}'                                            |           |              |                   |
      |                 |                 |                                                                         |           |              |                   |
      |                 |                 |     △：半角スペース                                                     |           |              |                   |
      |                 |                 |     ':シングル・ダブルコーテーションで必ず囲んで下さい。                |           |              |                   |
      |                 |                 |                                                                         |           |              |                   |
      |                 |                 | パラメータ値を変数で記述する場合の詳細は、\                             |           |              |                   |
      |                 |                 | 「 :ref:`ansible_common_option_var_listup` 」\                          |           |              |                   |
      |                 |                 | を参照してください 。                                                   |           |              |                   |
      |                 |                 |                                                                         |           |              |                   |
      |                 |                 | 変数の具体値は :menuselection:`Ansible-LegacyRole -->  代\              |           |              |                   |
      |                 |                 | 入値自動登録設定` から登録します。                                      |           |              |                   |
      |                 |                 |                                                                         |           |              |                   |
      |                 +-----------------+-------------------------------------------------------------------------+-----------+--------------+-------------------+
      |                 | オプション\     | Movement固有のオプションパラメータを入力します。                        | ー        | 手動入力     | 最大長4000バイト  |
      |                 | パラメータ      |                                                                         |           |              |                   |
      |                 |                 | オプションパラメータについての詳細は\                                   |           |              |                   |
      |                 |                 | 「 :ref:`ansible_common_option_parameter_list` 」\                      |           |              |                   |
      |                 |                 | を参照してください。                                                    |           |              |                   |
      |                 |                 |                                                                         |           |              |                   |
      |                 |                 | + | :menuselection:`Ansible共通 --> インターフェース情報`\              |           |              |                   |
      |                 |                 |      の :menuselection:`実行エンジン` が\                               |           |              |                   |
      |                 |                 |     「Ansible Core」の場合                                              |           |              |                   |
      |                 |                 |   | ansible-playbookコマンドの\                                         |           |              |                   |
      |                 |                 |     オプションパラメータを入力します。                                  |           |              |                   |
      |                 |                 |                                                                         |           |              |                   |
      |                 |                 | + | :menuselection:`Ansible共通 --> インターフェース情報`\              |           |              |                   |
      |                 |                 |     の :menuselection:`実行エンジン` が\                                |           |              |                   |
      |                 |                 |    「Ansible Automation Controller」の場合                              |           |              |                   |
      |                 |                 |                                                                         |           |              |                   |
      |                 |                 |   | ジョブテンプレートのパラメータを入力します。                        |           |              |                   |
      |                 |                 |   | ジョブテンプレートについての詳細は、\                               |           |              |                   |
      |                 |                 |     Ansible Automation Controller公式マニュアルのユーザガイド\          |           |              |                   |
      |                 |                 |     を参照してください。                                                |           |              |                   |
      |                 |                 |                                                                         |           |              |                   |
      |                 |                 | Movement共通のオプションパラメータ\                                     |           |              |                   |
      |                 |                 | は :menuselection:`Ansible共通 --> インターフェース情報` の\            |           |              |                   |
      |                 |                 | :menuselection:`オプションパラメータ` から入力します。                  |           |              |                   |
      |                 |                 |                                                                         |           |              |                   |
      |                 +-----------------+-------------------------------------------------------------------------+-----------+--------------+-------------------+
      |                 | ansible.cfg     | 作業実行時に使用するansible.cfgを\                                      | ー        | ファイル選択 | 最大サイズ100M\   |
      |                 |                 | アップロードします。                                                    |           |              | バイト            |
      |                 |                 |                                                                         |           |              |                   |
      |                 |                 | 未アップロードの場合は、デフォルトが使用され\                           |           |              |                   |
      |                 |                 | ます。                                                                  |           |              |                   |
      |                 |                 |                                                                         |           |              |                   |
      |                 |                 | また、 :menuselection:`Ansible-\                                        |           |              |                   |
      |                 |                 | LegacyRole --> ロールパッケージ管理` の :menuselection:`ロール\         |           |              |                   |
      |                 |                 | パッケージファイル（ZIP形式）` にansible.cfgが含まれている場合\         |           |              |                   |
      |                 |                 | は、アップロードしたansible.cfgで上書きされます。                       |           |              |                   |
      |                 |                 |                                                                         |           |              |                   |
      |                 +--------+--------+-------------------------------------------------------------------------+-----------+--------------+-------------------+
      |                 | Ansibl\| 実行\  | Ansible Automation Controllerに構築され\                                | ー        | リスト選択   | 説明欄記載のと\   |
      |                 | e Auto\| 環境   | ている実行環境が表示されます。                                          |           |              | おり。            |
      |                 | matio\ | ※2     |                                                                         |           |              |                   |
      |                 | n Cont\|        | 使用する実行環境を選択します。                                          |           |              |                   |
      |                 | roller\|        |                                                                         |           |              |                   |
      |                 | 利用\  |        | 未選択の場合は、Ansible Automation Controller\                          |           |              |                   |
      |                 | 情報   |        | に設定されているデフォルトの実行環境が使用されます。                    |           |              |                   |
      +-----------------+--------+--------+-------------------------------------------------------------------------+-----------+--------------+-------------------+
      | 備考                              | 自由記述欄です。                                                        | ー        | 手動入力     | 最大長4000バイト  |
      +-----------------------------------+-------------------------------------------------------------------------+-----------+--------------+-------------------+

   .. tip:: | ※1 ヘッダーセクションで「become: yes」を設定した場合
       | 作業対象に以下の設定が必要です。
       | ログインユーザの sudo権限を NOPASSWD付で :file:`/etc/sudoers` に設定します。
       |
       | 　　　**Demo_user ALL=(ALL) NOPASSWD:ALL**

   .. tip:: | ※2 「 :ref:`ansible_common_aac_sync` 」により取得したデータから選択します。

   .. warning:: | :menuselection:`WinRM接続` で「True」を選択した場合は接続するホストをすべてWindowsServerとみなします。


.. _ansible_legacyrole_role_package_list:

ロールパッケージ管理
~~~~~~~~~~~~~~~~~~~~

#. | ユーザが作成したロールパッケージファイル（zip）のメンテナンス（閲覧/登録/更新/廃止）を行います。
   | ロールパッケージファイルは、「roles」のある階層のディレクトリをzipにて圧縮したものを登録してください。ロールパッケージディレクトリ構成などは「 :ref:`ansible_legacyrole_write_role_package_ansible_legacy_role` 」を参照してください。

   .. figure:: /images/ja/ansible-legacyrole/role_packeage_management/role_package_list_v2-4.png
      :width: 800px
      :alt: サブメニュー画面（ロールパッケージ管理）

      サブメニュー画面（ロールパッケージ管理）

#. | :guilabel:`登録` ボタンより、ロールパッケージの登録を行います。

   .. figure:: /images/ja/ansible-legacyrole/role_packeage_management/registration_role_package_list_v2-4.gif
      :width: 800px
      :alt: 登録画面（ロールパッケージ管理）

      登録画面（ロールパッケージ管理）


#. | 登録画面の項目一覧は以下のとおりです。

   .. table:: 登録画面項目一覧（ロールパッケージ管理）
      :align: left

      +-----------------------------------+-------------------------------------------------------------------------------------+-----------+--------------+------------------------+
      | 項目                              | 説明                                                                                | 入力必須  | 入力方法     | 制約事項               |
      |                                   |                                                                                     |           |              |                        |
      |                                   |                                                                                     |           |              |                        |
      +===================================+=====================================================================================+===========+==============+========================+
      | 項番                              | 登録時に自動採番した36桁の文字列が表示されます。                                    | －        | 自動入力     | －                     |
      +-----------------------------------+-------------------------------------------------------------------------------------+-----------+--------------+------------------------+
      | ロールパッケージ名                | ITAで管理するロールパッケージ名を入力します。                                       | ○         | 手動入力     | 最大長255バイト        |
      +-----------------------------------+-------------------------------------------------------------------------------------+-----------+--------------+------------------------+
      | ロールパッケージファイル          | 作成したロールパッケージファイル（zip 形式）をアップロードします。                  | ○         | ファイル選択 | 最大サイズ100Mバイト   |
      |                                   |                                                                                     |           |              |                        |
      |                                   | アップロードするロールパッケージファイルに含まれるPlaybookファイルは、文字コードが\ |           |              |                        |
      |                                   | UTF-8でBOMなしで作成して下さい。                                                    |           |              |                        |
      +------------+----------------------+-------------------------------------------------------------------------------------+-----------+--------------+------------------------+
      | ターゲット | Linux                | Linuxで使用可能なPlaybookの場合、「＊」を選択します。                               | －        | リスト選択   | 説明欄記載のとおり。   |
      |            |                      |                                                                                     |           |              |                        |
      |            |                      | 未選択でも、作業実行に影響はありません。                                            |           |              |                        |
      |            +----------------------+-------------------------------------------------------------------------------------+-----------+--------------+------------------------+
      |            | Windows              | Windowsで使用可能なPlaybookの場合、「＊」を選択します。                             | －        | リスト選択   | 説明欄記載のとおり。   |
      |            |                      |                                                                                     |           |              |                        |
      |            |                      | 未選択でも、作業実行に影響はありません。                                            |           |              |                        |
      |            +----------------------+-------------------------------------------------------------------------------------+-----------+--------------+------------------------+
      |            | その他               | Linux、Windows以外の用途で使用可能なPlaybookの場合、Playbookの用途を入力します。    | －        | 手動入力     | 最大長4000バイト       |
      +------------+----------------------+-------------------------------------------------------------------------------------+-----------+--------------+------------------------+
      | Python要否                        | ターゲットの機器にPythonが必要の場合、「＊」を選択します。                          | －        | リスト選択   | 説明欄記載のとおり。   |
      |                                   |                                                                                     |           |              |                        |
      |                                   | 未選択でも、作業実行に影響はありません。                                            |           |              |                        |
      +-----------------------------------+-------------------------------------------------------------------------------------+-----------+--------------+------------------------+
      | 説明                              | Playbookについての説明を入力します。                                                | ー        | 手動入力     | 最大長4000バイト       |
      +-----------------------------------+-------------------------------------------------------------------------------------+-----------+--------------+------------------------+
      | 説明(en)                          | Playbookについての説明を英語で入力します。                                          | ー        | 手動入力     | 最大長4000バイト       |
      +-----------------------------------+-------------------------------------------------------------------------------------+-----------+--------------+------------------------+
      | 備考                              | 自由記述欄です。                                                                    | ー        | 手動入力     | 最大長4000バイト       |
      +-----------------------------------+-------------------------------------------------------------------------------------+-----------+--------------+------------------------+


.. warning:: | **ロールパッケージ内に定義した変数を取り出すタイミング**
   | 内部の処理でロールパッケージ内に定義している変数を抽出します。抽出した変数は、「 :ref:`ansible_legacyrole_substitution_value_auto_registration_setting` 」で具体値の登録が可能になります。
   | 抽出のタイミングはリアルタイムではないので、「 :ref:`ansible_legacyrole_substitution_value_auto_registration_setting` 」で変数が扱えるまでに **時間がかかる** 場合があります。

.. warning:: | Movement単位での変数名の一意管理
   | Ansible-LegacyRoleでは、変数抜出対象資材から抜出した変数名をMovement単位で一意管理します。
   | 同一ロールパッケージ内でロールを跨って同じ変数名を使用していて、変数構造が異なる場合、 :menuselection:`Ansible-LegacyRole --> ロールパッケージ管理` の登録でエラーとなります。
   | 具体的には、通常変数と多段変数や多段変数同士で多段構造が異なる場合、同じ変数名を使用していると登録でエラーとなります。
   | なお、ロールパッケージが異なる場合は上記の場合でも登録することが可能です。
   |
   | 具体例は下記の通りです。

   | e.g.)

   .. table:: 具体例
      :align: left

      +--------------+------------------------+--------------+--------------------------------------------------------------------------+-----------+------------------------------------------------------------------+
      | No.          | ロールパッケージ       | ロール       | defaults/main.yml                                                        | 動作\     | パターン                                                         |
      |              |                        |              |                                                                          |           |                                                                  |
      |              |                        |              |                                                                          |           |                                                                  |
      +==============+========================+==============+==========================================================================+===========+==================================================================+
      | 1            | package_A              | role1        | | VAR_SAMPLE:                                                            | 〇        | | ・変数名が同じ                                                 |
      |              |                        |              |                                                                          |           | | ・多段変数のメンバー変数の定義が同じ                           |
      |              |                        |              | |  - { VAR_001: "aaaa" , \VAR_002:\ "bbbb" }                             |           | | ・メンバー変数の記載順序が異なる                               |
      |              |                        |              |                                                                          |           |                                                                  |
      |              |                        +--------------+--------------------------------------------------------------------------+           |                                                                  |
      |              |                        | role2        | | VAR_SAMPLE:                                                            |           |                                                                  |
      |              |                        |              |                                                                          |           |                                                                  |
      |              |                        |              | |  - { VAR_002: "bbbb" , \VAR_001:\ "aaaa" }                             |           |                                                                  |
      |              |                        |              |                                                                          |           |                                                                  |
      +--------------+------------------------+--------------+--------------------------------------------------------------------------+-----------+------------------------------------------------------------------+
      | 2            | package_A              | role1        | | VAR_SAMPLE:                                                            | ×         | | ・変数名が同じ                                                 |
      |              |                        |              |                                                                          |           | | ・多段変数のメンバー変数の定義が異なる                         |
      |              |                        |              | |  - { VAR_001: "aaaa" , \VAR_002:\ "bbbb" }                             |           |                                                                  |
      |              |                        |              |                                                                          |           |                                                                  |
      |              |                        +--------------+--------------------------------------------------------------------------+           |                                                                  |
      |              |                        | role2        | | VAR_SAMPLE:                                                            |           |                                                                  |
      |              |                        |              |                                                                          |           |                                                                  |
      |              |                        |              | |  - { VAR_003: "aaaa" , \VAR_004:\ "bbbb" }                             |           |                                                                  |
      |              |                        |              |                                                                          |           |                                                                  |
      +--------------+------------------------+--------------+--------------------------------------------------------------------------+-----------+------------------------------------------------------------------+
      |3             | package_A              | role1        | | VAR_SAMPLE:                                                            | ×         | | ・変数名が同じ                                                 |
      |              |                        |              |                                                                          |           | | ・通常変数と多段変数が混在している                             |
      |              |                        |              | |  - { VAR_001: "aaaa" , \VAR_002:\ "bbbb" }                             |           |                                                                  |
      |              |                        |              |                                                                          |           |                                                                  |
      |              |                        +--------------+--------------------------------------------------------------------------+           |                                                                  |
      |              |                        | role2        | | VAR_SAMPLE: aaaa                                                       |           |                                                                  |
      |              |                        |              |                                                                          |           |                                                                  |
      |              |                        |              |                                                                          |           |                                                                  |
      |              |                        |              |                                                                          |           |                                                                  |
      +--------------+------------------------+--------------+--------------------------------------------------------------------------+-----------+------------------------------------------------------------------+


.. _ansible_legacyrole_movement_details:

Movement-ロール紐付
~~~~~~~~~~~~~~~~~~~

#. | Movementでインクルードするロールパッケージのメンテナンス（閲覧/登録/更新/廃止）を行います。

   .. figure:: /images/ja/ansible-legacyrole/movement_role/movement_role.png
      :width: 800px
      :alt: サブメニュー画面（Movement-ロール紐付）

      サブメニュー画面（Movement-ロール紐付）

#. | :guilabel:`登録` ボタンより、Movementでインクルードするロールパッケージの登録を行います。

   .. figure:: /images/ja/ansible-legacyrole/movement_role/registration_movement_role.gif
      :width: 800px
      :alt: 登録画面（Movement-ロール紐付）

      登録画面（Movement-ロール紐付）

#. | 登録画面の項目一覧は以下のとおりです。

   .. list-table:: 登録画面項目一覧（Movement-ロール紐付）
      :widths: 30 120 30 30 30
      :header-rows: 1
      :align: left

      * - 項目
        - 説明
        - 入力必須
        - 入力方法
        - 制約事項
      * - 項番
        - | 登録時に自動採番した36桁の文字列が表示されます。
        - ー
        - 自動入力
        - ー
      * - Movement
        - | :menuselection:`Ansible-LegacyRole --> Movement一覧` で登録した  :menuselection:`Movement名` が表示されます。
          | Movementを選択します。
        - 〇
        - リスト選択
        - ー
      * - ロールパッケージ名:ロール名
        - | :menuselection:`Ansible-LegacyRole --> ロールパッケージ管理` で登録した :menuselection:`ロールパッケージファイル（ZIP形式）` に含まれているロール名が表示されます。
          | Movementでインクルードするロールパッケージのロールを選択します。
          | 同一Movementに複数のロールパッケージは登録出来ません。
        - 〇
        - リスト選択
        - ー
      * - インクルード順序
        - | ロールの実行順序（1～）を入力します。
          | 入力されたインクルード順序（昇順）でロールが実行されます。
        - 〇
        - 手動入力
        - 1～2,147,483,647
      * - 備考
        - 自由記述欄です。
        - ー
        - 手動入力
        - 最大長4000バイト


.. _ansible_legacyrole_nested_variable_list:

変数ネスト管理
~~~~~~~~~~~~~~

#. | :menuselection:`Ansible-LegacyRole --> ロールパッケージ管理` で登録した :menuselection:`ロールパッケージファイル（ZIP形式）` で定義されている多段変数で、繰返配列が定義されているメンバー変数の配列の最大繰返数のメンテナンス（閲覧/更新）を行います。
   | 利用方法については、「 :ref:`ansible_legacyrole_substitution_value_auto_registration_setting` 」を参照てください。

   .. figure:: /images/ja/ansible-legacyrole/variable_nest_management/nested_variable_list.png
      :width: 800px
      :alt: サブメニュー画面（変数ネスト管理）

      サブメニュー画面（変数ネスト管理）

#. | :guilabel:`編集` ボタンより最大繰返数の更新を行います。

   .. figure:: /images/ja/ansible-legacyrole/variable_nest_management/registration_nested_variable_list.gif
      :width: 800px
      :alt: 登録画面（変数ネスト管理）

      登録画面（変数ネスト管理）

#. | 登録画面の項目一覧は以下のとおりです。

   .. list-table:: 登録画面項目一覧（変数ネスト管理）
      :widths: 30 120 30 30 30
      :header-rows: 1
      :align: left

      * - 項目
        - 説明
        - 入力必須
        - 入力方法
        - 制約事項
      * - 項番
        - | 登録時に自動採番した36桁の文字列が表示されます。
        - ー
        - 自動入力
        - ー
      * - 最大繰返数
        - | 配列の最大繰返数を1～1,024の範囲で入力します。
          | 最大繰返数の上限値は「管理コンソール - :ref:`system_setting`」より識別ID「MAXIMUM_ITERATION_ANSIBLE-LEGACYROLE」の設定値にて、1～1024の範囲内で変更することが可能です。
        - 〇
        - 手動入力
        - 入力値1～1,024(「:ref:`system_setting`」の設定値により変動)
      * - 備考
        - 自由記述欄です。
        - ー
        - 手動入力
        - 最大長4000バイト


.. warning:: | **初期登録および繰返数の更新タイミング**
   | 内部の処理でロールパッケージ内に定義している多段変数繰返配列で定義されているメンバー変数の繰返数を初期登録します。初期登録後、変数ネスト管理で繰返数を更新することが出来ます。
   | なお、初期登録および繰返数の更新はリアルタイムではないので、「 :ref:`ansible_legacyrole_substitution_value_auto_registration_setting` 」で変数が扱えるまでに **時間がかかる** 場合があります。


.. _ansible_legacyrole_substitution_value_auto_registration_setting:

代入値自動登録設定
~~~~~~~~~~~~~~~~~~

#. | パラメータシートの項目の設定値とMovementの変数との紐付管理（閲覧/登録/更新/廃止）を行います。
   | 登録した情報は作業実行により :menuselection:`Ansible-LegacyRole --> 代入値管理` と :menuselection:`Ansible-LegacyRole--> 作業対象ホスト` に反映されます。

   .. figure:: /images/ja/ansible-legacyrole/substitution_value_automatic_setting/substitution_value_auto_registration_setting_role.png
      :width: 800px
      :alt: サブメニュー画面（代入値自動登録設定）

      サブメニュー画面（代入値自動登録設定）

#. | :guilabel:`登録` ボタンより、パラメータシートの項目の設定値とMovementの変数との紐付登録を行います。

   .. figure:: /images/ja/ansible-legacyrole/substitution_value_automatic_setting/registration_substitution_value_auto_registration_setting_role.gif
      :width: 800px
      :alt: 登録画面（代入値自動登録設定）

      登録画面（代入値自動登録設定）


#. | 登録画面の項目一覧は以下のとおりです。


   .. table:: 登録画面項目一覧（代入値自動登録設定）
      :align: left

      +-----------------------------------+--------------------------------------------------------------------+----------------------------------------------+--------------+-----------------------------+
      | 項目                              | 説明                                                               | 入力必須                                     | 入力方法     | 制約事項                    |
      |                                   |                                                                    |                                              |              |                             |
      |                                   |                                                                    |                                              |              |                             |
      +=================+=================+====================================================================+==============================================+==============+=============================+
      | 項番                              | 登録時に自動採番した36桁の文字列が表示されます。                   | ー                                           | 自動入力     | ー                          |
      +-----------------+-----------------+--------------------------------------------------------------------+----------------------------------------------+--------------+-----------------------------+
      | パラメータシー\ | メニューグルー\ | パラメータシートの項目が表示されます。                             | ○                                            | リスト選択   | 説明欄記載のとおり。        |
      | ト（From）      | プ:メニュー:項目|                                                                    |                                              |              |                             |
      |                 |                 | 対象の項目を選択します。                                           |                                              |              |                             |
      |                 |                 |                                                                    |                                              |              |                             |
      |                 +-----------------+--------------------------------------------------------------------+----------------------------------------------+--------------+-----------------------------+
      |                 | 代入順序        | パラメータシートがバンドルの\                                      | :ref:`※1 <ansible_legacyrole_parashi_\       | 手動入力     | 1～2,147,483,647            |
      |                 |                 | 場合、パラメータシートで登録\                                      | substitution>`                               |              |                             |
      |                 |                 | している :menuselection:`代入順序` を入力します。                  |                                              |              |                             |
      |                 |                 |                                                                    |                                              |              |                             |
      +-----------------+-----------------+--------------------------------------------------------------------+----------------------------------------------+--------------+-----------------------------+
      | 登録方式                          | :menuselection:`IaC変数（To）` で選択した変数の具体値\             | ○                                            | リスト選択   | 説明欄記載のとおり。        |
      |                                   | に設定する内容を選択します。                                       |                                              |              |                             |
      |                                   |                                                                    |                                              |              |                             |
      |                                   | + | Value型                                                        |                                              |              |                             |
      |                                   |   | 項目の設定値が :menuselection:`IaC変数（To）` で選択した変数\  |                                              |              |                             |
      |                                   |     の具体値になります。                                           |                                              |              |                             |
      |                                   |                                                                    |                                              |              |                             |
      |                                   | + | Key型                                                          |                                              |              |                             |
      |                                   |   | 項目の名称が :menuselection:`IaC変数（To）` で選択した変数\    |                                              |              |                             |
      |                                   |     の具体値になります。                                           |                                              |              |                             |
      |                                   |                                                                    |                                              |              |                             |
      +-----------------------------------+--------------------------------------------------------------------+----------------------------------------------+--------------+-----------------------------+
      | Movement名                        | :menuselection:`Ansible-LegacyRole --> Movement一覧` で登録した\   | ○                                            | リスト選択   | 説明欄記載のとおり。        |
      |                                   | :menuselection:`Movement名` が表示されます。                       |                                              |              |                             |
      |                                   |                                                                    |                                              |              |                             |
      |                                   | Movementを選択します。                                             |                                              |              |                             |
      +-----------------+-----------------+--------------------------------------------------------------------+----------------------------------------------+--------------+-----------------------------+
      | IaC変数（To）   | Movement名\     | :menuselection:`Ansible-LegacyRole --> Movement-ロール紐付` で\    | ○                                            | リスト選択   | 説明欄記載のとおり。        |
      |                 | :変数名         | 登録した資材で使用している変数が表示されます。                     |                                              |              |                             |
      |                 |                 |                                                                    |                                              |              |                             |
      |                 |                 | :menuselection:`パラメータシート（From）` で選択した項目の具体値\  |                                              |              |                             |
      |                 |                 | を紐付けたい変数を選択します。                                     |                                              |              |                             |
      |                 +-----------------+--------------------------------------------------------------------+----------------------------------------------+--------------+-----------------------------+
      |                 | Movement名:変\  | :menuselection:`Movement名:変数名` で多段変数を選択した場合に\     | :ref:`※2 <ansible_legacyrole_member>`        | リスト選択   | 説明欄記載のとおり。        |
      |                 | 数名:メンバー\  | 多段変数のメンバー変数が表示されます。                             |                                              |              |                             |
      |                 | 変数            |                                                                    |                                              |              |                             |
      |                 |                 | メンバー変数を選択します。                                         |                                              |              |                             |
      |                 +-----------------+--------------------------------------------------------------------+----------------------------------------------+--------------+-----------------------------+
      |                 | 代入順序        | 複数具体値が設定できる変数の場合に必須入力になります。             | :ref:`※3 <ansible_legacyrole_substitution>`  | 手動入力     | 1～2,147,483,647            |
      |                 |                 |                                                                    |                                              |              |                             |
      |                 |                 | 具体値の代入順序（1～）を入力します。入力値に\                     |                                              |              |                             |
      |                 |                 | 従い昇順で代入されます。具体値が複数ない場合で\                    |                                              |              |                             |
      |                 |                 | も代入順序（1～）を入力します。                                    |                                              |              |                             |
      +-----------------+-----------------+--------------------------------------------------------------------+----------------------------------------------+--------------+-----------------------------+
      | NULL連携                          | パラメータシートの具体値が\                                        | ー                                           | リスト選択   | 説明欄記載のとおり。        |
      |                                   | NULL（空白）の場合に\                                              |                                              |              |                             |
      |                                   | :menuselection:`Ansible-LegacyRole --> 代入値管理` に\             |                                              |              |                             |
      |                                   | NULL（空白）の値を登録するかを選択します。                         |                                              |              |                             |
      |                                   |                                                                    |                                              |              |                             |
      |                                   | + | True                                                           |                                              |              |                             |
      |                                   |   | パラメータシートの値がどのような\                              |                                              |              |                             |
      |                                   |     値でも :menuselection:`Ansible-LegacyRole --> 代入値管理` に\  |                                              |              |                             |
      |                                   |     登録が行われます。                                             |                                              |              |                             |
      |                                   |                                                                    |                                              |              |                             |
      |                                   | + | False                                                          |                                              |              |                             |
      |                                   |   | パラメータシートに値が入力\                                    |                                              |              |                             |
      |                                   |     されていれば :menuselection:`Ansible-LegacyRole --> 代入値管\  |                                              |              |                             |
      |                                   |     理` に登録が行われます。                                       |                                              |              |                             |
      |                                   |                                                                    |                                              |              |                             |
      |                                   | 未選択の場合、\                                                    |                                              |              |                             |
      |                                   | :menuselection:`Ansible共通 --> インターフェース情報` の\          |                                              |              |                             |
      |                                   | :menuselection:`NULL連携` の値が適用されます。                     |                                              |              |                             |
      |                                   |                                                                    |                                              |              |                             |
      +-----------------------------------+--------------------------------------------------------------------+----------------------------------------------+--------------+-----------------------------+
      | 備考                              | 自由記述欄です。                                                   | ー                                           | 手動入力     | 最大長4000バイト            |
      +-----------------------------------+--------------------------------------------------------------------+----------------------------------------------+--------------+-----------------------------+

.. _ansible_legacyrole_parashi_substitution:

.. tip:: | ※1:パラメータシート（バンドル）を使用する場合のみ必須
   | パラメータシート（バンドル）のリピート設定されている項目とMovementの変数を紐付ける場合、 :menuselection:`Ansible-LegacyRole --> 代入値自動登録設定` でパラメータシート（From） の代入順序を入力する必要があります。
   | パラメータシート（バンドル）と代入値自動登録設定の関係を以下の図に示します。

   .. figure:: /images/ja/diagram/parameter.png
      :width: 600px
      :alt: パラメータシート（バンドル）使用時の代入値自動登録設定登録方法


.. _ansible_legacyrole_member:

.. tip:: | ※2:選択した変数が多段変数の場合のみ必須
   | 多段変数の場合にのみメンバー変数の選択が必要になります。メンバー変数に表示される変数は具体値を必要とする変数のみです。
   | メンバー変数名の表示は各階層の変数を「.」でつないで表示します。
   | 繰返配列の場合は「[ ]」で繰返位置（0～）をつないで表示します。繰返し配列の数は :menuselection:`Ansible-LegacyRole --> 変数ネスト管理` で設定を行います。
   |
   | e.g.） 代入値自動登録設定で選択できるメンバー変数と変数ネスト管理で最大繰返数を更新後に選択できるメンバー変数の確認

   #. | 下記のようにロールパッケージの変数定義ファイル（defaults/main.yml）に変数を定義して、 :menuselection:`Ansible-LegacyRole --> ロールパッケージ管理` でロールパッケージを登録します。
      | **変数定義ファイルの記述内容**

      .. code-block:: yaml

         VAR_aaaa:
           - name: alice
             object: obj1
             directory:
               - craete_dir: /dir
             password:
               - craete_pass:
                 sample:
                   - sample_pass: pass1
               - craete_pass:
                 sample:
                   - sample_pass: pass2
             user:
               root:
                 - craete_users:
                   prod:
                     - prod_user: user1
                   dev:
                     - dev_user: user2


   #. | 1. のように変数を定義してロールパッケージを登録した場合、 :menuselection:`Ansible-LegacyRole --> 変数ネスト管理` には下記のように登録され、 :menuselection:`Ansible-LegacyRole --> 代入値自動登録設定` ではデフォルトで下記のメンバー変数が選択できます。

      .. list-table:: 変数ネスト管理の登録内容
         :widths: 40 30 30
         :header-rows: 1
         :align: left

         * - 変数名
           - メンバー変数名
           - 最大繰返数
         * - VAR_aaaa
           - 0
           - 1
         * - VAR_aaaa
           - 0.directory
           - 1
         * - VAR_aaaa
           - 0.password
           - 1
         * - VAR_aaaa
           - 0.password.sample
           - 1
         * - VAR_aaaa
           - 0.user.root
           - 1
         * - VAR_aaaa
           - 0.user.root.dev
           - 1
         * - VAR_aaaa
           - 0.user.root.prod
           - 1

      .. list-table:: 代入値自動登録設定で選択可能なメンバー変数
         :widths: 40 50
         :header-rows: 1
         :align: left

         * - 変数名
           - メンバー変数名
         * - VAR_aaaa
           - [0].directory[0].create_dir
         * - VAR_aaaa
           - [0].name
         * - VAR_aaaa
           - [0].object
         * - VAR_aaaa
           - [0].password[0].create_pass
         * - VAR_aaaa
           - [0].password[0].sample[0].sample_pass
         * - VAR_aaaa
           - [0].user.root[0].create_users
         * - VAR_aaaa
           - [0].user.root[0].dev[0].dev_user
         * - VAR_aaaa
           - [0].user.root[0].prod[0].prod_user


   #. | :menuselection:`Ansible-LegacyRole --> 変数ネスト管理` でメンバー変数「0.user.root.prod」の最大繰返数を初期値"1"から"3"に更新します。

      .. list-table:: 変数ネスト管理の更新内容
         :widths: 40 30 30
         :header-rows: 1
         :align: left

         * - 変数名
           - メンバー変数名
           - 最大繰返数
         * - VAR_aaaa
           - 0.user.root.prod
           - 3


   #. | 3. のようにメンバー変数を更新した場合、 :menuselection:`Ansible-LegacyRole --> 代入値自動登録設定` で選択できるメンバー変数も下記のように更新されます。
      | （メンバー変数 [0].user.root[0].prod[1].prod_user と [0].user.root[0].prod[2].prod_user がプルダウンに追加されました。）

      .. list-table:: 代入値自動登録設定で選択可能なメンバー変数
         :widths: 40 50
         :header-rows: 1
         :align: left

         * - 変数名
           - メンバー変数名
         * - VAR_aaaa
           - [0].directory[0].create_dir
         * - VAR_aaaa
           - [0].name
         * - VAR_aaaa
           - [0].object
         * - VAR_aaaa
           - [0].password[0].create_pass
         * - VAR_aaaa
           - [0].password[0].sample[0].sample_pass
         * - VAR_aaaa
           - [0].user.root[0].create_users
         * - VAR_aaaa
           - [0].user.root[0].dev[0].dev_user
         * - VAR_aaaa
           - [0].user.root[0].prod[0].prod_user
         * - VAR_aaaa
           - [0].user.root[0].prod[1].prod_user
         * - VAR_aaaa
           - [0].user.root[0].prod[2].prod_user



.. _ansible_legacyrole_substitution:

.. tip:: | ※3:選択した変数が複数具体値設定可能な変数の場合のみ必須
   | 特定の複数具体値変数に対して代入順序が連続していなくても問題ありません。
   | 連続していない場合は詰めて処理されます。
   |
   | e.g.）複数具体値変数に代入順序を入力して作業実行する場合

   #. | 下記のようにロールパッケージの変数定義ファイル（defaults/main.yml）に変数を定義して、 :menuselection:`Ansible-LegacyRole --> ロールパッケージ管理` でロールパッケージを登録します。
      | **変数定義ファイルの記述内容**

      .. code-block:: yaml

         VAR_substitutionA:
           - user-name
           - group-name
           - meta-name

         VAR_substitutionB:
           - login
           - authorized
           - space
           - cluster

   #. | :menuselection:`Ansible-LegacyRole --> 代入値自動登録設定` でパラメータシートに登録されている項目の設定値とRole内の変数を紐付けします。

      .. table:: パラメータシートの登録内容
         :align: left

         +----------------+------------------------+----------+----------+----------+----------+
         | **ホスト名**   | **オペレーション名**   | **パラメータ**                            |
         |                |                        +----------+----------+----------+----------+
         |                |                        | **項目1**| **項目2**| **項目3**| **項目4**|
         +================+========================+==========+==========+==========+==========+
         | test-host      | test-ope               | value1   | value2   | value3   | value4   |
         +----------------+------------------------+----------+----------+----------+----------+

      .. list-table:: 代入値自動登録設定の登録内容
         :widths: 40 20 30 20
         :header-rows: 1
         :align: left

         * - メニュー名
           - 項目
           - 変数名
           - 代入順序
         * - sample-menu
           - 項目1
           - VAR_substitutionA
           - 30
         * - sample-menu
           - 項目2
           - VAR_substitutionA
           - 10
         * - sample-menu
           - 項目3
           - VAR_substitutionA
           - 20
         * - sample-menu
           - 項目1
           - VAR_substitutionB
           - 2
         * - sample-menu
           - 項目2
           - VAR_substitutionB
           - 4
         * - sample-menu
           - 項目3
           - VAR_substitutionB
           - 1
         * - sample-menu
           - 項目4
           - VAR_substitutionB
           - 3

   #. | 作業実行時、ホスト変数ファイル（host_vars/test-host）には、代入値自動登録設定で登録した変数が下記のように出力されます。
      | **ホスト変数ファイルへの出力内容**

      .. code-block:: yaml

         VAR_substitutionA:
           - value2
           - value3
           - value1
         VAR_substitutionB:
           - value3
           - value1
           - value4
           - value2

.. _host:

.. tip:: | **ホスト変数ファイルへの出力**
   | 代入値自動登録設定で登録した変数のみが作業実行時にホスト変数ファイルへ出力されます。
   | 多段変数も同様で具体値を登録しているメンバー変数のみとなります。
   |
   | e.g.） 代入値自動登録設定で具体値を登録した変数と作業実行時にホスト変数ファイルに出力される変数の確認

   #. | 下記のようにロールパッケージの変数定義ファイル（defaults/main.yml）に変数を定義して、 :menuselection:`Ansible-LegacyRole --> ロールパッケージ管理` でロールパッケージを登録します。
      | **変数定義ファイルの記述内容**

      .. code-block:: yaml

         VAR_output:
           - name: alice
             group: root
             user:
               root:
                 - craete_users:
                   prod:
                     - prod_user: user1
                   dev:
                     - dev_user: user2

   #. | :menuselection:`Ansible-LegacyRole --> 代入値自動登録設定` でパラメータシートに登録されている項目の設定値とRole内の変数を紐付けします。

      .. table:: パラメータシートの登録内容
         :align: left

         +----------------+------------------------+---------------------+
         | ホスト名       | オペレーション名       | パラメータ          |
         |                |                        +----------+----------+
         |                |                        | 項目1    | 項目2    |
         +================+========================+==========+==========+
         | test-host      | test-ope               | value1   | value2   |
         +----------------+------------------------+----------+----------+

      .. list-table:: 代入値自動登録設定の登録内容
         :widths: 30 15 30 50
         :header-rows: 1
         :align: left

         * - メニュー名
           - 項目
           - 変数名
           - メンバー変数名
         * - sample-menu
           - 項目1
           - VAR_output
           - [0].name
         * - sample-menu
           - 項目2
           - VAR_output
           - [0].user.root[0].dev[0].dev_user


   #. | 作業実行時、ホスト変数ファイル（host_vars/test-host）には、代入値自動登録設定で登録した変数が下記のように出力されます。
      | **ホスト変数ファイルへの出力内容**

      .. code-block:: yaml

         VAR_output:
           - name: value1
             user:
               root:
               - dev:
                 - dev_user: value2

.. _ansible_legacyrole_file_and_templete:

.. tip:: | **ファイル埋込変数とテンプレート埋込変数をPlaybookの変数に紐付して使用する例**
   | e.g.） ファイル埋込変数 CPF_test とテンプレート埋込変数 TPF_sample を代入値自動登録設定でPlaybookの変数に紐付して使用する場合

   #. | :menuselection:`Ansible共通 --> ファイル管理` ／ :menuselection:`Ansible共通 --> テンプレート管理` で下記のように登録します。

      .. list-table:: ファイル管理の登録内容
         :widths: 50 40
         :header-rows: 1
         :align: left

         * - ファイル埋込変数名
           - ファイル素材
         * - CPF_test
           - test_file.txt

      .. list-table:: テンプレート管理の登録内容
         :widths: 50 40
         :header-rows: 1
         :align: left

         * - テンプレート埋込変数名
           - テンプレート素材
         * - TPF_sample
           - sample.tpl

   #. | :menuselection:`パラメータシート定義・作成` で「Ansible共通:ファイル管理:ファイル埋込変数名」「Ansible共通:テンプレート管理:テンプレート埋込変数名」をパラメータシートの項目としてパラメータシート作成後、パラメータシートで項目の設定値としてファイル埋込変数とテンプレート埋込変数を登録します。

      .. figure:: /images/ja/ansible_common/menu_definition_and_create/menu_create.png
         :width: 800px
         :alt: パラメータシート定義・作成画面

         パラメータシート定義・作成画面

      .. table:: サンプルパラメータシートの登録内容
         :align: left

         +----------------+------------------------+-----------------+---------------------+
         | **ホスト名**   | **オペレーション名**   | **パラメータ**                        |
         |                |                        +-----------------+---------------------+
         |                |                        | **ファイル管理**| **テンプレート管理**|
         +================+========================+=================+=====================+
         | test-host      | test-ope               | CPF_test        | TPF_sample          |
         +----------------+------------------------+-----------------+---------------------+

   #. | :menuselection:`Ansible-LegacyRole --> 代入値自動登録設定` で2. のパラメータシートに登録した項目の設定値とPlaybookの変数を紐付して :menuselection:`Ansible-LegacyRole --> 作業実行` で作業実行します。

      .. list-table:: 代入値自動登録設定の登録内容
         :widths: 50 30 30
         :header-rows: 1
         :align: left

         * - メニュー名
           - 項目
           - 変数名
         * - サンプルパラメータシート
           - ファイル管理
           - VAR_filetest
         * - サンプルパラメータシート
           - テンプレート管理
           - VAR_temptest

   #. | :menuselection:`Ansible-LegacyRole --> 作業状態確認` の :guilabel:`代入値確認` ボタンで具体値に '{{ CPF_test }}' '{{ TPF_sample }}' が反映されていることが確認できます。

      .. figure:: /images/ja/ansible-legacyrole/assigned_value_management/general_operations_note.png
         :width: 800px
         :alt: 作業状態確認の代入値管理

         作業状態確認の代入値管理


.. _ansible_legacyrole_execution:

作業実行
~~~~~~~~

| 作業対象のMovementをMovement一覧から選択します。
| 作業対象のオペレーションをオペレーション一覧から選択します。
| 作業実行には、3種類の実行種別があります。実行種別に応じたボタンをクリックすることで :menuselection:`Ansible-LegacyRole --> 作業状態確認` に遷移し、実行されます。

.. figure:: /images/ja/ansible-legacyrole/execution/execution_screen.gif
   :width: 800px
   :alt: 作業実行画面

   作業実行画面

| 実行種別ついて以下に説明します。

#. | **作業実行**
   | :guilabel:`作業実行` ボタンをクリックすると、作業対象に対して構築作業を実行します。

#. | **ドライラン**
   | :guilabel:`ドライラン` ボタンをクリックすると、実際に作業対象に対して構築作業をせず、ドライランを行うことができます。
   | ドライランを行った場合の動作は、Ansible-Playbookコマンドの--checkパラメータを指定した実行となります。

#. | **パラメータ確認**
   | :guilabel:`パラメータ確認` ボタンをクリックすると、実際に作業対象に対して構築作業をせず、 :menuselection:`Ansible-LegacyRole --> 代入値自動登録設定` に登録してある情報から作業対象のオペレーションとMovementに紐付く情報を :menuselection:`Ansible-LegacyRole --> 代入値管理` と :menuselection:`Ansible-LegacyRole --> 作業対象ホスト` に反映し、確認することが出来ます。

.. tip:: |  **予約日時の指定**
   | 「予約日時」を入力することで、実行を予約することがきます。
   | 「予約日時」には、未来の日時のみ入力可能です。


.. _ansible_legacyrole_check_operation_status:

作業状態確認
~~~~~~~~~~~~

| 作業の実行状態を監視します。

.. figure:: /images/ja/ansible-legacyrole/check_work_status/check_operation_status.png
   :width: 800px
   :alt: サブメニュー画面（作業状態確認）

   サブメニュー画面（作業状態確認）

#. | **実行状態表示**
   | 実行状況に応じた「ステータス」が表示されます。
   | また、実行ログ、エラーログに実行状況の詳細が表示されます。
   | 「実行種別」には、作業実行の場合は「通常」、ドライランの場合は「ドライラン」、パラメータ確認の場合は「パラメータ確認」が表示されます。
   | ステータスが想定外エラーで終了した場合、エラーログにメッセージが表示されます。
   | 「呼出元Conductor」には、Conductorから実行した場合に、どのConductorから実行されたかを表示します。Ansible-LegacyRoleから直接実行した場合は空欄になります。

#. | **作業対象ホスト確認**
   | :guilabel:`作業対象ホスト確認` ボタンで :menuselection:`Ansible-LegacyRole --> 作業対象ホスト` が表示され、作業対象のオペレーションとMovementに絞り込んだホストが表示されます。

#. | **代入値確認**
   | :guilabel:`代入値確認` ボタンで :menuselection:`Ansible-LegacyRole --> 代入値管理` が表示され、作業対象のオペレーションとMovementに絞り込んだ変数と具体値が表示されます。

#. | **緊急停止/予約取り消し**
   | :guilabel:`緊急停止` ボタンで構築作業を停止させることができます。
   | また、実行前の「予約実行」の作業の場合は、 :guilabel:`予約取消` ボタンが表示されます。 :guilabel:`予約取消` ボタンで予約実行が取り消せます。

#. | **実行ログ表示**
   | Ansible Automation Controllerで実行した場合、作業対象の :menuselection:`Ansible共通 --> 機器一覧` の :menuselection:`ユーザ` ・ :menuselection:`パスワード` ・ :menuselection:`ssh秘密鍵ファイル` ・ :menuselection:`パスフレーズ` ・ :menuselection:`接続タイプ` ・ :menuselection:`インスタンスグルーブ` の項目値でグループ化された作業対象の単位でPlaybookが実行され、ansibleの実行ログが分割されます。
   | さらに、 :menuselection:`Ansible共通 --> インターフェース情報` か :menuselection:`Ansible-LegacyRole --> Movement一覧` の :menuselection:`オプションパラメータ` でジョブスライス数を指定することによりグループ化された作業対象をさらにジョブスライス数で分割しplaybookが実行され、ansibleの実行ログも分割されます。
   | 実行ログが分割された場合、実行ログがTabで分割表示され、表示したい実行ログを選択する事ができます。

   | 実行ログのTabに表示される名称は以下の2種類があります。
   | exec.log: 全ての実行ログをまとめたログファイルです。
   | exec.log以外: 分割された実行ログファイルです。ファイル命名規則は以下になります。
   | exec_<グループ番号>_<通番>

   .. list-table:: 分割された実行ログファイルの命名要素
      :widths: 20 50
      :header-rows: 1
      :align: left

      * - 要素
        - 内容
      * - グループ番号
        - 作業対象の :menuselection:`Ansible共通 --> 機器一覧` の :menuselection:`ユーザ` ・ :menuselection:`パスワード` ・ :menuselection:`ssh秘密鍵ファイル` ・ :menuselection:`パスフレーズ` ・ :menuselection:`接続タイプ` ・ :menuselection:`インスタンスグルーブ` の項目値でグルーブ化した 1 からの通番です。
      * - 通番
        - | ジョブスライス数の設定によりグループ内を分割した 1 からの通番です。
          | 0 の場合はジョブスライス数で分割されなかったことを表します。

#. | **ログ検索**
   | 実行ログ、エラーログは、各ログのログ検索テキストボックスに検索したい文字列を入力することで、入力した文字列の箇所がハイライトで表示されます。
   | また、「ログ検索」のチェックボックスをチェックすると、該当する行だけが表示されます。
   | 実行ログ、エラーログのリフレッシュ表示間隔と最大表示行数を、  :menuselection:`Ansible共通 --> インターフェース情報`  の  :menuselection:`状態監視周期（単位ミリ秒）` と :menuselection:`進行状態表示行数` で設定できます。

#. | **投入データ**
   | 実行したPlaybookなどをダウンロードすることができます。
   | 投入データの構成は「 :ref:`ansible_legacyrole_the_linkage_between_the_input_data_used_during_ansible_execution_and_ita_menu` 」を参照してください。

#. | **結果データ**
   | 実行ログ、エラーログなどをダウンロードすることができます。
   | 結果データの構成は「 :ref:`ansible_legacyrole_the_linkage_between_the_output_data_used_during_ansible_execution_and_ita_menu` 」を参照してください。

.. _ansible_legacyrole_execution_list:

作業管理
~~~~~~~~

| 作業の履歴を閲覧できます。
| 条件を指定し :guilabel:`フィルタ` ボタンをクリックすると、該当する作業の履歴を閲覧できます。
| :guilabel:`詳細` ボタンで :menuselection:`Ansible-LegacyRole --> 作業状態確認` に遷移し、実行状態の詳細を閲覧することができます。

.. figure:: /images/ja/ansible-legacyrole/work_management/execution_list.png
   :width: 800px
   :alt: サブメニュー画面（作業管理）


   サブメニュー画面（作業管理）

#. | 閲覧画面の項目一覧は以下のとおりです。

   .. table:: 閲覧画面項目一覧（作業管理）
      :widths: 10 10 10 50
      :align: left

      +-------------------------------------------------------------------------------+------------------------------------------------------------------------------+
      | 項目                                                                          | 説明                                                                         |
      |                                                                               |                                                                              |
      +===============================================================================+==============================================================================+
      | 作業No.                                                                       | 自動採番した36桁の文字列が表示されます。                                     |
      +-------------------------------------------------------------------------------+------------------------------------------------------------------------------+
      | 実行種別                                                                      | 実行種別を表示します。                                                       |
      +-------------------------------------------------------------------------------+------------------------------------------------------------------------------+
      | ステータス                                                                    | 作業実行のステータスを表示します。                                           |
      +-------------------------------------------------------------------------------+------------------------------------------------------------------------------+
      | 実行エンジン                                                                  | 作業実行した実行エンジンを表示します。                                       |
      +-------------------------------------------------------------------------------+------------------------------------------------------------------------------+
      | 呼出元Conductor                                                               | Conductorから実行した場合にConductor名が表示されます。                       |
      +-------------------------------------------------------------------------------+------------------------------------------------------------------------------+
      | 実行ユーザ                                                                    | 作業実行したユーザ名が表示されます。                                         |
      +-------------------------------------------------------------------------------+------------------------------------------------------------------------------+
      | 登録日時                                                                      | 作業実行でボタンをクリックした日時が表示されます。                           |
      +---------------------+---------------------------------------------------------+------------------------------------------------------------------------------+
      | Movement            | ID                                                      | 作業実行で選択したMovementのIDが表示されます。                               |
      |                     +---------------------------------------------------------+------------------------------------------------------------------------------+
      |                     | 名称                                                    | 作業実行で選択したMovementの名称が表示されます。                             |
      |                     +---------------------------------------------------------+------------------------------------------------------------------------------+
      |                     | 遅延タイマー                                            | 作業実行で選択したMovementの遅延タイマーが表示されます。                     |
      |                     +-------------------------------+-------------------------+------------------------------------------------------------------------------+
      |                     | Ansible利用情報               | ホスト指定形式          | 作業実行で選択したMovementのホスト指定形式が表示されます。                   |
      |                     |                               +-------------------------+------------------------------------------------------------------------------+
      |                     |                               | WinRM接続               | 作業実行で選択したMovementのWinRM接続が表示されます。                        |
      |                     |                               +-------------------------+------------------------------------------------------------------------------+
      |                     |                               | ヘッダーセクション      | 作業実行で選択したMovementのヘッダーセクションが表示されます。               |
      |                     |                               +-------------------------+------------------------------------------------------------------------------+
      |                     |                               | ansible.cfg             | 作業実行で選択したMovementのansible.cfgがアップロード出来ます。              |
      |                     +-------------------------------+-------------------------+------------------------------------------------------------------------------+
      |                     | Ansible Automation \          | 実行環境                | 作業実行で選択したMovementの実行環境が表示されます。                         |
      |                     | Controller 利用情報           |                         |                                                                              |
      +---------------------+-------------------------------+-------------------------+------------------------------------------------------------------------------+
      | オペレーション      | No.                                                     | 作業実行で選択したオペレーションのIDが表示されます。                         |
      |                     +---------------------------------------------------------+------------------------------------------------------------------------------+
      |                     | 名称                                                    | 作業実行で選択したオペレーションの名称が表示されます。                       |
      +---------------------+---------------------------------------------------------+------------------------------------------------------------------------------+
      | 投入データ                                                                    | 投入データ一式をzip形式でアップロード出来ます。                              |
      +-------------------------------------------------------------------------------+------------------------------------------------------------------------------+
      | 結果データ                                                                    | 結果データ一式をzip形式でアップロード出来ます。                              |
      +---------------------+---------------------------------------------------------+------------------------------------------------------------------------------+
      | 作業状況            | 予約日時                                                | 作業実行で予約日時を設定した場合に予約日時が表示されます。                   |
      |                     +---------------------------------------------------------+------------------------------------------------------------------------------+
      |                     | 開始日時                                                | 作業実行を開始した日時が表示されます。                                       |
      |                     +---------------------------------------------------------+------------------------------------------------------------------------------+
      |                     | 終了日時                                                | 作業実行が終了した日時が表示されます。                                       |
      +---------------------+---------------------------------------------------------+------------------------------------------------------------------------------+
      | 収集状況            | ステータス                                              | 収集機能のステータスを表示します。                                           |
      |                     +---------------------------------------------------------+------------------------------------------------------------------------------+
      |                     | 収集ログ                                                | 収集機能のログがダウンロード出来ます。                                       |
      +---------------------+---------------------------------------------------------+------------------------------------------------------------------------------+
      | Conductorインスタンス番号                                                     | Conductorから実行された場合にConductorインスタンス番号を表示します。         |
      |                                                                               |                                                                              |
      +---------------------+---------------------------------------------------------+------------------------------------------------------------------------------+


.. _ansible_legacyrole_target_host:

作業対象ホスト
~~~~~~~~~~~~~~

#. | 作業実行毎の作業対象ホストを閲覧できます。

   .. figure:: /images/ja/ansible-legacyrole/work_taget_host/target_host.png
      :width: 800px
      :alt: サブメニュー画面（作業対象ホスト）

      サブメニュー画面（作業対象ホスト）


#. | 閲覧画面の項目一覧は以下のとおりです。

   .. list-table:: 閲覧画面項目一覧（作業対象ホスト）
      :widths: 45 120
      :header-rows: 1
      :align: left

      * - 項目
        - 説明
      * - 項番
        - 作業実行時に自動採番した36桁の文字列が表示されます。
      * - 作業No
        - 作業実行時の作業Noが表示されます。
      * - オペレーション
        - 作業実行時のオペレーションが表示されます。
      * - Movement名
        - 作業実行時のMovementが表示されます。
      * - ホスト名
        - 作業実行時の対象ホストが表示されます。
      * - 備考
        - 自由記述欄です。


.. _ansible_legacyrole_substitution_value_list:

代入値管理
~~~~~~~~~~

#. | 作業実行毎の変数の具体値を閲覧できます。

   .. figure:: /images/ja/ansible-legacyrole/assigned_value_management/substitution_value_list.png
      :width: 800px
      :alt: サブメニュー画面（代入値管理）

      サブメニュー画面（代入値管理）


#. | 閲覧画面の項目一覧は以下のとおりです。

   .. table:: 閲覧画面項目一覧（代入値管理）
      :align: left

      +-------------------------------------------+-------------------------------------------------------------------------------------------------------------+
      | 項目                                      | 説明                                                                                                        |
      +===========================================+=============================================================================================================+
      | 項番                                      | 作業実行時に自動採番した36桁の文字列が表示されます。                                                        |
      +-------------------------------------------+-------------------------------------------------------------------------------------------------------------+
      | 作業No                                    | 作業実行時の作業Noが表示されます。                                                                          |
      +-------------------------------------------+-------------------------------------------------------------------------------------------------------------+
      | オペレーション                            | 作業実行時のオペレーションが表示されます。                                                                  |
      +-------------------------------------------+-------------------------------------------------------------------------------------------------------------+
      | Movement名                                | 作業実行時のMovementが表示されます。                                                                        |
      +-------------------------------------------+-------------------------------------------------------------------------------------------------------------+
      | ホスト名                                  | 作業実行時の作業対象ホストが表示されます。                                                                  |
      +-------------------------------------------+-------------------------------------------------------------------------------------------------------------+
      | Movement名:変数名                         | 作業実行時の変数が表示されます。                                                                            |
      +-------------------------------------------+-------------------------------------------------------------------------------------------------------------+
      | Movement名:変数名:メンバー変数            | 多段変数のメンバー変数が表示されます。                                                                      |
      +------------+-----------+------------------+-------------------------------------------------------------------------------------------------------------+
      | 具体値     | 文字列    | Sensitive設定    | 「True」または「False」が表示されます。                                                                     |
      |            |           |                  |                                                                                                             |
      |            |           +------------------+-------------------------------------------------------------------------------------------------------------+
      |            |           | 値               | 作業実行時の変数の具体値が表示されます。                                                                    |
      |            |           |                  |                                                                                                             |
      |            |           |                  | + | :menuselection:`Sensitive設定` が「True」の場合                                                         |
      |            |           |                  |   | パラメータシートで入力した具体値は暗号化されITA上では表示されません。\                                  |
      |            |           |                  |     変数の具体値は、ansible-vaultで暗号化した内容が設定されます。                                           |
      |            |           |                  |                                                                                                             |
      |            |           |                  | + | :menuselection:`Sensitive設定` が「False」の場合                                                        |
      |            |           |                  |   | パラメータシートで入力した具体値が表示されます。                                                        |
      |            |           |                  |                                                                                                             |
      |            +-----------+------------------+-------------------------------------------------------------------------------------------------------------+
      |            | ファイル                     | 作業実行の変数に紐づくファイル名が表示されます。                                                            |
      +------------+------------------------------+-------------------------------------------------------------------------------------------------------------+
      | 代入順序                                  | 複数具体値変数の場合に、代入順序が表示されます。                                                            |
      +-------------------------------------------+-------------------------------------------------------------------------------------------------------------+
      | 備考                                      | 自由記述欄です。                                                                                            |
      +-------------------------------------------+-------------------------------------------------------------------------------------------------------------+


構築コード記述方法
==================

.. _ansible_legacyrole_write_role_package_ansible_legacy_role:

ロールパッケージの記述
----------------------

| ロールパッケージの基本書式については、Ansible公式マニュアルのAnsibleベストプラクティスを参照してください。
| 「 :ref:`ansible_legacyrole_role_package_list` 」でアップロードするロールパッケージファイルのZipに含めるべきディレクトリと、ITAでの扱いについて記述します。

.. code-block:: none

   （上位ディレクトリ）
   │
   ├─── site.yml                                             ・・・・・・・・・・・・・・・・・・・・・・・・ （1）
   │
   ├─── hosts                                                ・・・・・・・・・・・・・・・・・・・・・・・・ （2）
   │
   ├─── group_vars                                           ・・・・・・・・・・・・・・・・・・・・・・・・ （3）
   │
   ├─── host_vars                                            ・・・・・・・・・・・・・・・・・・・・・・・・ （4）
   │
   ├─── ITA readme                                           ・・・・・・・・・・・・・・・・・・・・・・・・ （5）
   │
   └─── roles                                                ・・・・・・・・・・・・・・・・・・・・・・・・ （6）
           │
           ├─ [role名①]                                       ・・・・・・・・・・・・・・・・・・・・・・・・ （7）
           │     │
           │     ├── readme.md                               ・・・・・・・・・・・・・・・・・・・・・・・・ （8）
           │     │
           │     ├── tasks                                   ・・・・・・・・・・・・・・・・・・・・・・・・ （9）
           │     │      ├── main.yml
           │     │      └── user_files
           │     │      └── user.yml
           │     │
           │     ├── handlers                                ・・・・・・・・・・・・・・・・・・・・・・・・ （10）
           │     │      ├── main.yml
           │     │      └── user_files
           │     │      └── user.yml
           │     │
           │     ├── templates                               ・・・・・・・・・・・・・・・・・・・・・・・・ （11）
           │     │      ├── hosts.j2
           │     │      └── user_files
           │     │      └── user.j2
           │     │
           │     ├── files                                   ・・・・・・・・・・・・・・・・・・・・・・・・ （12）
           │     │      └── sudoers
           │     │
           │     ├── vars                                    ・・・・・・・・・・・・・・・・・・・・・・・・ （13）
           │     │      └─ main.yml
           │     │
           │     ├── defaults                                ・・・・・・・・・・・・・・・・・・・・・・・・ （14）
           │     │      ├── main.yml
           │     │      └── user_files
           │     │              └── user.yml
           │     │
           │     ├── meta                                    ・・・・・・・・・・・・・・・・・・・・・・・・ （15）
           │     │      └── main.yml
           │     │
           │     上記以外のディレクトリやファイルが存在する場合、 ITAは関知しません。
           │
           └─ [role名②] ロールの数に特に制限はありません。

.. list-table::
   :widths: 25 15 40
   :header-rows: 1
   :align: left

   * -
     - | 含めるべきファイル
       | 〇　：必要
       | △　：任意
     - ITAでの取り扱い
   * - \（1）\　site.yml　\（マスターPlaybook）\
     - △
     - ITAで作成されるため、存在する場合は上書きされます。
   * - \（2）\　hosts
     - △
     - ITAで作成されるため、存在する場合は上書きされます。
   * - \（3）\　group_vars
     - △
     - ITAでは扱わないため、存在する場合は削除されます。
   * - \（4）\　host_vars
     - △
     - ITAで作成されるため、存在する場合は上書きされます。
   * - \（5）\　ITA readme
     - △
     - | ITA readmeはロール毎に定義します。無くてもエラーにはなりません。
       | ITA readmeは、文字コードがUTF-8のBOMなしで作成してください。
       | 詳細については「 :ref:`ansible_legacyrole_write_ita_readme_ansible_legacy_role_only` 」をご確認ください。
   * - \（6）\　roles
     - 〇
     - rolesディレクトリが存在しない場合はアップロードでエラーになります。
   * - \（7）\　roles/[role 名①]
     - 〇
     - | role名ディレクトリが存在しない場合はアップロードでエラーになります。
       | tasksディレクトリを含むディレクトリをroleとして扱います。
       | ディレクトリ階層が深くても問題ありません。
   * - \（8）\　roles/[role 名①]/readme.md
     - △
     - ITA は関知しません。
   * - \（9）\　roles/[role 名①]/tasks
     - 〇
     - | tasksディレクトリは必須です。
       | playbookファイルは、文字コードがUTF-8のBOMなで作成してください。
       | main.ymlがない場合はアップロードでエラーになります。
       | main.yml以外のファイルも配置できます。
       | サブディレクトリにmain.yml以外のファイルを配置できます。
   * - \（10）\　roles/[role 名①]/handlers
     - △
     - | handlersディレクトリの有無は関知しません。
       | playbookファイルは、文字コードがUTF-8のBOMなしで作成してください。
       | main.ymlの有無は関知しません。
       | main.yml以外のファイルも配置できます。
       | サブディレクトリにファイルを配置できます。
   * - \（11）\　roles/[role 名①]/templates
     - △
     - | templatesディレクトリの有無は関知しません。
       | ファイルは、文字コードがUTF-8のBOMなしで作成してください。 
       | サブディレクトリにファイルを配置できます。
   * - \（12）\　roles/[role 名①]/files
     - △
     - | filesディレクトリの有無は関知しません。
       | ファイル及びサブディレクトリの有無は関知しません。
       | ファイル内容は関知しません。
   * - \（13）\　roles/[role 名①]/vars
     - △
     - | varsディレクトリの有無は関知しません。
       | playbookファイルは、文字コードがUTF-8のBOMなしで作成してください。
       | ファイル及びサブディレクトリの有無は関知しません。
       | ファイル内容は関知しません。
   * - \（14）\　roles/[role 名①]/defaults
     - △
     - | defaultsディレクトリの有無は関知しません。
       | playbookファイルは、文字コードがUTF-8のBOMなしで作成してください。
       | main.ymlの有無は関知しません。
       | main.yml以外のファイルも配置できます。
       | サブディレクトリにmain.yml以外のファイルを配置できます。
   * - \（15）\　roles/[role 名①]/meta
     - △
     - | metaディレクトリの有無は関知しません。
       | playbookファイルは、文字コードがUTF-8のBOMなしで作成してください。
       | ファイル及びサブディレクトリの有無は関知しません。
       | ファイル内容は関知しません。


マスターPlaybook
~~~~~~~~~~~~~~~~

| ITAで作成するマスターPlaybookはへッダーセクションとrolesセクションで構成されます。

#. | へッダーセクション
   | ヘッダーセクションは、デフォルト値が決まっていますが、 :menuselection:`Ansible-LegacyRole --> Movement一覧` の :menuselection:`ヘッダーセクション` で変更することが出来ます。

   | ▼ヘッダーセクションのデフォルト値

   .. code-block:: yaml

        - hosts: all
          remote_user: "{{ __loginuser__ }}"
          gather_facts: no
          become: yes
        # winrm接続の場合は「become: yes」は省略されます。

#. | rolesセクション
   | アップロードさたロールパッケージ内のロールを、 :menuselection:`Ansible-LegacyRole --> Movement-ロール紐付` の :menuselection:`インクルード順序` に従いroleで実行します。

   .. figure:: /images/ja/diagram/role_session.png
      :align: center
      :width: 8.85417in
      :height: 6.67187in


ロールパッケージ内のロール名をディレクトリ階層にした場合の留意点
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

| 下記のようなディレクトリ階層のロールパッケージを例に説明します。

.. code-block:: none

   └── roles
          ├── parent
          │     ├── sample_role1
          │     │ ├── defaults
          │     │ └── tasks
          │     └── sample_role2
          │            ├── defaults
          │            ├── sample_role3
          │            │     ├── defaults
          │            │     └── tasks
          │            ├── sample_role4
          │            │     ├── defaults
          │            │     └── tasks
          │            └── tasks
          ├── sample_role5
          │     └── defaults
          └── sample_role6
                 ├── defaults
                 └── tasks


#. | ロールとして認識するディレクトリは、tasksディレクトリがあるディレクトリになります。
   | この例だと、ロールして扱うディレクトリ階層（ロール名）は以下の3個になります。

   - parent/sample_role1
   - parent/sample_role2
   - sample_role6

#. | tasksディレクトリが複数あるディレクトリ階層の除外
   | parent/sample_role2/sample_role3とparent/sample_role2/sample_role4にもtasksディレクトリがありますが、parent/sample_role2にtasksディレクトリがありロールとして認識していますので、ロールとして扱いません。


.. _ansible_legacyrole_write_ita_readme_ansible_legacy_role_only:

ITAreadme の記述
----------------

| Playbook中に直接変数を定義したくない場合など、defaults変数定義ファイルに変数が定義されていない際に、ITA readmeファイルに変数の定義を設定することで、代入値管理機能で変数の値を指定することができます。

ITA readmeのファイル名の命名規則
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

| 　ita_readme_[ロール名].yml
| 　e.g.）

.. list-table::
   :widths: 20 40
   :header-rows: 1
   :align: left

   * - ロール名
     - 作成するファイル名
   * - mysql
     - ita_readme_mysql.yml
   * - mysql/install
     - ita_readme_mysql%install.yml


.. warning:: | roleのディレクトリ階層が深い場合、ロール名に含まれる / を % に置き換える必要があります。


ITA readmeのフォーマット
~~~~~~~~~~~~~~~~~~~~~~~~

| フォーマットはYAML形式となります。
| 文字コードはUTF-8のBOMなしで作成してください。
| ITA readmeに定義されている変数の具体値がホスト変数ファイルに出力されるまでの流れを、以降「 :ref:`代入値管理機能。<ansible_common_legacy_role_var_value>` 」と称します。
| また、ITA readmeとdefaults変数定義ファイルで変数定義が重なった場合、ITA readmeの変数構造が適用されます。

.. tip:: | ITA readmeとdefaults変数定義ファイルで変数定義が重なった場合など、以下のルールで処理されます。

  .. list-table:: 変数採用ルール
     :widths: 30 30 50
     :header-rows: 1
     :align: left

     * - defaults変数定義ファイル
       - ITA readme
       - 変数構造の適用先
     * - 定義あり
       - 定義なし
       - デフォルト変数定義ファイル
     * - 定義なし
       - 定義あり
       - ITA readme
     * - 定義あり
       - 定義あり
       - ITA readme


  | ITA readmeは、作業実行時はロールパッケージから切り離されます。
  | ITA readmeに記載した変数と具体値は、ansibleに渡ることはありません。


「ita_readme」の活用例
----------------------

| Ansible-LegacyRoleにおける「ita_readme」の活用例について、観点1～7を列挙します。
|
| 前提として、Ansible-LegacyRole（「roles」ディレクトリ）は外部から取得したものとします。
| 以下は、「ita_readme」を用いてアップロードから結果確認までを表した全体イメージ図です。

.. figure:: /images/ja/diagram/ansible-legacyrole_usage_base.png
   :width: 1000px
   :alt: 全体イメージ図

   全体イメージ図

| 以降、上記の図をベースに観点1～7について掘り下げていきます。

.. list-table:: Ansible Automation Controllerシステム要件
   :widths: 35 80
   :header-rows: 1
   :align: left

   * - No.
     - 観点
   * - 1
     - 外部から取得したAnsible-LegacyRoleを編集せず利用する
   * - 2
     - 「ita_readme」の役割
   * - 3
     - 「defaults/main.yml」に記載の変数定義およびデフォルト値について
   * - 4
     - 「host_varsファイル」と「ITAのパラメータシート」について
   * - 5
     - 「defaults/main.yml」に追記したい場合の救済処置
   * - 6
     - playbookにおけるlength評価への応用
   * - 7
     - playbookにおけるdefined評価への応用


- | **観点１：外部から取得したAnsible-LegacyRoleを編集せず利用する**
  | 外部（Galaxy等）から取得したAnsible-LegacyRole（「roles」ディレクトリ）は編集を加えずに利用いただくことが可能です。
  | そのため「ita_readme」を「roles」ディレクトリの外に置いて、Ansible-LegacyRole（「roles」ディレクトリ）内で使われている変数にパラメータを与えることが可能となっております。

.. figure:: /images/ja/diagram/ansible-legacyrole_usage_example1.png
   :width: 1000px
   :alt: 観点１のイメージ図

   観点１のイメージ図


- | **観点２：「ita_readme」の役割について**
  | 「ita_readme」は変数名および変数の型をITAに伝えるための機能です。
  | 言い換えれば、「ita_readme」は変数の具体値（パラメータ）を定義するための機能ではありません（具体値を記載してもITAで認識しません）。
  |
  | 具体値を与える方法を以降の観点で説明します。

.. figure:: /images/ja/diagram/ansible-legacyrole_usage_example2.png
   :width: 1000px
   :alt: 観点２のイメージ図

   観点２のイメージ図

- | **観点３：「defaults/main.yml」に記載の変数定義およびデフォルト値について**
  | 「roles」配下の「defaults/main.yml」はそのまま変更なくansibleに渡されます。
  | 変数定義およびデフォルト値はhost_varsで定義されない限り有効となります。（例：『VAR_A：aaa』）

.. figure:: /images/ja/diagram/ansible-legacyrole_usage_example3.png
   :width: 1000px
   :alt: 観点３のイメージ図

   観点３のイメージ図

- | **観点４：「host_varsファイル」と「ITAのパラメータシート」について**
  | host_varsファイルはITAのパラメータシートから実行ごとに自動作成されます。

.. figure:: /images/ja/diagram/ansible-legacyrole_usage_example4.png
   :width: 1000px
   :alt: 観点４のイメージ図

   観点４のイメージ図

- | **観点５：「defaults/main.yml」に追記したい場合の救済処置**
  | Ansible-LegacyRole（「roles」ディレクトリ）に変更を加えたい場合、救済処置として「ita_readme」に変数名および型を記述することが可能です。
  |
  | 既に「defaults/main.yml」に記載がある変数を、改めて「ita_readme」に定義する必要はありません。
  | もし二つのファイルで同じ変数が定義されている場合は、「ita_readme」側が優位になります。
  |
  | ※下図のとおり、変数「VAR_H」を「ita_readme」に記述することで変数の追加が可能

.. figure:: /images/ja/diagram/ansible-legacyrole_usage_example5.png
   :width: 1000px
   :alt: 観点５のイメージ図

   観点５のイメージ図

- | **観点６：playbookにおけるlength評価への応用**
  | 変数に対し具体値があるか否かによって、length評価における条件分岐に活用することが可能です。
  | 例えば、「defaults/main.yml」に『VAR_C:[]』がある状態で、変数「VAR_C」に具体値を与えずに実行した場合length＝0となります。
  | 反対に、何らかの具体値を与えて実行した場合length＞0となります。（例：『VAR_X:sss』）

.. figure:: /images/ja/diagram/ansible-legacyrole_usage_example6.png
   :width: 1000px
   :alt: 観点６のイメージ図

   観点６のイメージ図

- | **観点７：playbookにおけるdefined評価への応用**
  | 変数に対し具体値を定義しているか否かによって、defined評価による条件分岐に活用することが可能です。
  | 例えば、「defaults/main.yml」で定義のない変数「VAR_G」と「VAR_H」を、「ita_readme」で定義を記述します。「ita_readme」に記述することで、ITAのパラメータシートで取り扱うことが可能となります。
  |
  | 変数「VAR_G」に具体値を付与せず実行すると、「defaults/main.yml」および「host_vars」に定義されずに動作するためdefined→falseとなります。
  | 反対に、変数「VAR_H」に具体値「kkk」を付与し実行すると、「host_vars」に定義されて動作するためdefined→trueとなります。

.. figure:: /images/ja/diagram/ansible-legacyrole_usage_example7.png
   :width: 1000px
   :alt: 観点７のイメージ図

   観点７のイメージ図


付録
====

.. _ansible_legacyrole_the_linkage_between_the_input_data_used_during_ansible_execution_and_ita_menu:

Ansible実行時に使用される投入データとITAメニューの紐づけ
--------------------------------------------------------
| ITAの各メニューより情報を抜出してAnsible実行に必要な投入データを作ります。この際、 :menuselection:`Ansible共通 --> 機器一覧` の :menuselection:`パスワード` や :menuselection:`Ansible-LegacyRole --> 代入値管理` で :menuselection:`Sensitive設定` が「True」に設定されている変数の具体値は、ansible-vaultで暗号化されています。
| 「投入データ」はZIP形式で :menuselection:`Ansible-LegacyRole --> 作業状態確認` の :menuselection:`投入データ` よりダウンロードが可能です。
| ダウンロードした投入データを所定のディレクトリに解凍することで、Ansibleを直接実行することも可能です。
|
| 各種データとITAメニューの関係性は以下の通りです。


Ansible-LegacyRole投入データ
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. list-table:: Ansible-LegacyRole投入データ
   :widths: 20 20 30 20
   :header-rows: 1
   :align: left

   * - メニューグループ
     - メニュー
     - 項目
     - ディレクトリ解凍時のパス
   * - Ansible-LegacyRole
     - ロールパッケージ管理
     - ロールパッケージ
     - /roles
   * - Ansible 共通
     - テンプレート管理
     - テンプレート素材
     - /template_files
   * - Ansible 共通
     - ファイル管理
     - ファイル素材
     - /copy_files
   * - Ansible-LegacyRole
     - 代入値管理
     - 具体値（ファイル）
     - /upload_files
   * - Ansible 共通
     - グローバル変数管理
     - 変数名/具体値
     - /host_vars
   * - Ansible-LegacyRole
     - 代入値管理
     - 変数名/具体値
     - /host_vars
   * - Ansible-LegacyRole
     - template 管理
     - テンプレート埋込変数
     - /host_vars
   * - Ansible-LegacyRole
     - ファイル管理
     - ファイル埋込変数
     - /host_vars
   * - Ansible共通
     - 機器一覧
     - | ログインユーザ ID
       | ログインパスワード   ※ansible-vault で暗号化
       | ホスト名
       | DNSホスト名
       | IPアドレス
     - /host_vars
   * - Ansible共通
     - 機器一覧
     - ssh 認証鍵ファイル
     - /ssh_key_files
   * - Ansible共通
     - 機器一覧
     - サーバ証明書
     - /winrm_ca_files
   * - Ansible共通
     - インターフェース情報
     - オプションパラメータ
     - /AnsibleExecOption.txt
   * - Ansible-LegacyRole
     - Movement一覧
     - オプションパラメータ
     - /AnsibleExecOption.txt
   * - Ansible共通
     - 機器一覧
     - | ログインユーザ ID
       | ログインパスワード  ※ansible-vault で暗号化
       | ホスト名
       | DNSホスト名
       | IP アドレス
       | インベントリファイル追加オプション
       | WinRM 接続情報
       | 接続オプション
     - /hosts
   * - Ansible-LegacyRole
     - Movement-ロール紐付
     - ロール名・インクルード順序
     - /site.yml


.. _ansible_legacyrole_the_linkage_between_the_output_data_used_during_ansible_execution_and_ita_menu:

Ansible実行時に作成される結果データ
-----------------------------------

| 「投入データ」をansibleで実行した結果を「結果データ」としてZIP形式で保存します。
| 「結果データ」はZIP形式で :menuselection:`Ansible-LegacyRole --> 作業状態確認` の :menuselection:`結果データ` よりダウンロードが可能です。


Ansible-LegacyRole 結果データに保存されるファイル一覧
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. list-table:: Ansible-LegacyRole結果データに保存されるファイル一覧
   :widths: 20 50 20 20
   :header-rows: 1
   :align: left

   * - ファイル名
     - 記録内容
     - Ansible Coreの場合
     - Ansible Automation Controllerの場合
   * - result.txt
     - Ansibleの実行結果を記録
     - 〇
     -
   * - error.log
     - | 作業実行時のエラーメッセージ出力先ファイル
       | Ansible-playbbokコマンドの標準エラー出力の出力先ファイル
       | 作業実行確認のエラーログに表示される内容
     - 〇
     - 〇
   * - exec.log.org
     - Ansible-playbbokコマンドの標準出力の出力先ファイル
     - 〇
     - 〇
   * - exec.log
     - | Aexec.log.orgを加工したファイル
       | 作業実行確認の実行ログに表示される内容
     - 〇
     - 〇
   * - exec_<作業番号>_<グループ番号>
     - | 分割された実行ログファイル
       | ファイル名の命名規則は「 :ref:`ansible_legacyrole_check_operation_status` 」の実行ログ表示を参照してください。
     -
     - 〇
   * - forced.txt
     - 緊急停止をした場合の記録ファイル
     - 〇
     -
   * - user_files
     - 実行したplaybookでITA独自変数「\__\workflowdir\__\」にファイル出力をした場合の出力先ディレクトリ。
     - 〇
     - 〇

