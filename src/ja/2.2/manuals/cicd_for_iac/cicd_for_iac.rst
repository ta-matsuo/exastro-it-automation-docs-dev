=================
CI/CD For IaC機能
=================

はじめに
********

| 本書では、CI/CD For IaC機能の機能および操作方法について説明します。


用語の定義
**********

| 本書では以下として記載します。

.. table:: 用語説明
   
   +------------+--------------------------------------------------------+
   | 用語名     | 内容                                                   |
   +============+========================================================+
   | ITA        | 「Exastro IT Automation」の略語です。                  |
   +------------+--------------------------------------------------------+
   | 紐付元資材 | CI/CD For \                                            |
   |            | IaC機能で連携するGitリポジトリ内の資材を表します。     |
   +------------+--------------------------------------------------------+
   | 紐付先資材 | ITAの連携ドライバ「Ansibl\                             |
   |            | e-Driver」と「Terraform-Cloud/EP-Driver」と\           |
   |            | 「Terraform-CLI-Driver」の下記メニューから\            |
   |            | アップロードする資材を表します。                       |
   |            |                                                        |
   |            | - Ansible-Legacy/Playbook素材集                        |
   |            |                                                        |
   |            | - Ansible-Pioneer/対話ファイル素材集                   |
   |            |                                                        |
   |            | - Ansible-LegacyRole/ロールパッケージ管理              |
   |            |                                                        |
   |            | - Ansible共通/ファイル管理                             |
   |            |                                                        |
   |            | - Ansible共通/テンプレート管理                         |
   |            |                                                        |
   |            | - Terraform-Cloud-EP/Module素材集                      |
   |            |                                                        |
   |            | - Terraform-Cloud-EP/Policy管理                        |
   |            |                                                        |
   |            | - Terraform-CLI/Module素材集                           |
   +------------+--------------------------------------------------------+


CI/CD For IaC機能の概要
***********************

機能概要
========

| CI/CD For IaC機能は、大きく分けて2つの機能があります。

#. | Git連携機能

   | ITA内にGitリポジトリのクローンを作成します。
   | クローンを介して定期的に紐付元資材の更新を検知しITAの「リモートリポジトリ資材」メニューに一覧を作成します。

#. | 資材紐付機能

   | 紐付元資材と紐付先資材の紐付を登録し、紐付先資材の動作検証を行う為のオペレーションとMovementを登録します。
   | 紐付元資材が更新されると、紐付先資材が自動更新され、動作検証を行う為のオペレーションとMovementで作業実行を行います。


機能概要図
==========

| CI/CD For IaC機能の概要図を以下に示します。


.. image:: /images/ja/cicd_for_iac/CICD_overviews.png
   :width: 800px

CI/CD For IaC機能 メニュー構成
******************************

| 本章では、CI/CD For IaC機能のメニュー構成について説明します。


メニュー/画面一覧
=================

| CI/CD For IaC機能のメニュー一覧を以下に記述します。

.. table:: 表 2.1-1 CI/CD For IaC機能 メニュー一覧
   
   +--------+---------------+---------------+---------------+
   | **No** | **メニュ\     | **メニ\       | **概要**      |
   |        | ーグループ**  | ュー・画面**  |               |
   +========+===============+===============+===============+
   | 1      | CI/CD For IaC | リモー\       | Gitリポジトリ\|
   |        |               | トリポジトリ  | の情報を管理  |
   +--------+               +---------------+---------------+
   | 2      |               | リモートリ\   | Gitリ\        |
   |        |               | ポジトリ資材  | ポジトリの資\ |
   |        |               |               | 材情報を管理  |
   |        |               |               |               |
   |        |               |               | ※インストー\  |
   |        |               |               | ル時は非表示\ |
   |        |               |               | のメニュー\   |
   |        |               |               | です。        |
   +--------+               +---------------+---------------+
   | 3      |               | 資材紐付      | 紐付\         |
   |        |               |               | 元資材と紐付\ |
   |        |               |               | 先資材との紐\ |
   |        |               |               | 付情報を管理\ |
   +--------+---------------+---------------+---------------+

  

CI/CD For IaC機能 利用手順
**************************

| CI/CD For IaC機能の利用手順について説明します。

作業フロー
==========

| CI/CD For IaC機能の標準的な作業フローは以下のとおりです。
| 各作業の詳細は次項に記載しています。

.. image:: /images/ja/cicd_for_iac/CICD_flow.png
   :width: 5.68819in
   :height: 3.35972in


**作業フロー詳細と参照先**

#. | リモートリポジトリの登録
   | 連携するGitリポジトリの情報を登録します。
   | 詳細は「:ref:`cicd_for_iac_remote_repository`」メニューを参照してください。

#. | 資材紐付の登録
   | 紐付元資材と紐付先資材の紐付を登録します。
   | 詳細は「:ref:`cicd_for_iac_file_link`」メニューを参照してください。

#. | 資材紐付にオペレーション+Movementの情報を登録
   | 更新された紐付先資材の動作検証を行う場合に、オペレーションとMovementを登録します。
   | 詳細は「:ref:`cicd_for_iac_file_link`」メニューを参照してください。

#. | 自動での資材更新と動作検証の確認
   | 紐付元資材が更新される度に、紐付先資材が自動更新されることを確認します。
   | また、オペレーションとMovementを登録している場合に、作業実行が自動で行われることを確認します。
   | 詳細は「:ref:`cicd_for_iac_file_link`」メニューを参照してください。


CI/CD For IaC機能メニュー操作説明
*********************************

| 本章では、CI/CD For IaC機能のメニュー操作について説明します。


 
CI/CD For IaC メニュー
==========================

| 本節では、CI/CD For IaC機能をインストールした状態で表示されるメニューの操作について記載します。

.. _cicd_for_iac_remote_repository:

リモートリポジトリ
------------------

1. | 「リモートリポジトリ」メニューでは、連携するGItリポジトリの情報を登録します。

.. figure:: /images/ja/cicd_for_iac/remote_repository_menu.png
   :width: 800px
   :alt: サブメニュー画面（リモートリポジトリ）

   サブメニュー画面（リモートリポジトリ）

2. | リモートリポジトリ画面の入力項目は以下の通りです。

   .. table:: リモートリポジトリ画面 入力項目一覧
      
      +---------------+----------------------------------+----------+---------------+-----------------+
      | **項目**      | **説明**                         | **入力\  | **入\         | **制\           |          
      |               |                                  | 必須**   | 力形式**      | 約事項**        |          
      +===============+==================================+==========+===============+=================+
      | リモート\     | CI/CD For IaC 機能の各メニューで\| 〇       | 手動入力      | 最大長255バイト |
      | リポジトリ名  | リモートリポジトリを示す名称を\  |          |               |                 |
      |               | 示す名称を入力してください。     |          |               |                 |       
      +---------------+----------------------------------+----------+---------------+-----------------+
      | リモート\     | git clone コマンドに指定する Git\| 〇       | 手動入力      | 最大長255バイト |
      | リポジトリ    | リポジトリの URL を入力してくだ\ |          |               |                 |
      | (URL)         | さい。                           |          |               |                 |
      +---------------+----------------------------------+----------+---------------+-----------------+
      | ブランチ      | git cloneコマンドに指定する Git\ | ー       | 手動入力      | 最大長255バイト |            
      |               | リポジトリのブランチ名を入力して\|          |               |                 | 
      |               | 下さい。                         |          |               |                 |
      |               |                                  |          |               |                 |  
      |               | 未入力時は default ブランチが\   |          |               |                 |    
      |               | 指定されます。                   |          |               |                 |   
      +---------------+----------------------------------+----------+---------------+-----------------+
      | プロトコル    | Gitリポジトリと接続するプロトコ\ | 〇       | リスト選択    |                 |
      |               | ルを選択して下さい。             |          |               |                 |
      |               |                                  |          |               |                 |      
      |               | ● https                          |          |               |                 |
      |               |                                  |          |               |                 | 
      |               | リモートのGitリポジトリとhttpsで\|          |               |                 |
      |               | 接続する場合に選択してください。 |          |               |                 | 
      |               |                                  |          |               |                 |     
      |               | ● sshパスワード認証              |          |               |                 |
      |               |                                  |          |               |                 |
      |               | リモートのGitリポジトリとsshの\  |          |               |                 |
      |               | パスワード認証で接続する場合に\  |          |               |                 |
      |               | 選択して下さい。                 |          |               |                 |
      |               |                                  |          |               |                 | 
      |               | ● ssh鍵認証(パスフレーズなし)\   |          |               |                 | 
      |               | ※現在使用できません。            |          |               |                 | 
      |               |                                  |          |               |                 | 
      |               | リモートのGitリポジトリとsshの鍵\|          |               |                 |
      |               | 認証で接続する場合に選択して\    |          |               |                 |    
      |               | 下さい。                         |          |               |                 |
      |               |                                  |          |               |                 |
      |               | ● ssh鍵認証(パスフレーズあり)\   |          |               |                 |
      |               | ※現在使用できません。            |          |               |                 | 
      |               |                                  |          |               |                 | 
      |               | リモートのGitリポジトリとsshの\  |          |               |                 |       
      |               | パスフレーズ付鍵認証で接続する\  |          |               |                 |
      |               | 場合に選択して下さい。           |          |               |                 |
      +---------------+----------------------------------+----------+---------------+-----------------+ 
      | Visibility\   | GitリポジトリのVisibilityタイプ\ | ー       | リスト選択    |                 |                                    
      | タイプ        | (Public/Private)を選択して\      |          |               |                 |
      |               | 下さい。                         |          |               |                 |    
      |               | プロトコルでhttpsを選択した場合、|          |               |                 |      
      |               | Visibilityタイプの選択は必須\    |          |               |                 |
      |               | 入力です。                       |          |               |                 |    
      +------+--------+----------------------------------+----------+---------------+-----------------+
      | Git\ | ユーザ | Git cloneコマンド実行時に求め\   | ー       | 手動入力      | 最大長255バイト |                           
      | アカ\|        | られるユーザを入力して下さい。   |          |               |                 |
      | ウン\|        | VisibilityタイプでPrivateを選択\ |          |               |                 | 
      | ト   |        | した場合、ユーザの入力は必須で\  |          |               |                 |
      |      |        | す。                             |          |               |                 |
      |      +--------+----------------------------------+----------+---------------+-----------------+
      |      | パス\  | Gitのcloneコマンドを実行した際に\| ー       | 手動入力      | 最大長255バイト | 
      |      | ワード | 求められるパスワードを入力して\  |          |               |                 |  
      |      |        | ください。                       |          |               |                 |
      |      |        |                                  |          |               |                 |    
      |      |        | Visibility タイプでPrivateを選択\|          |               |                 |
      |      |        | した場合、パスワードの入力は必須\|          |               |                 |
      |      |        | です。                           |          |               |                 | 
      |      |        |                                  |          |               |                 |            
      |      |        | 尚、GitHubでは2021年8月13 日で\  |          |               |                 |          
      |      |        | パスワード認証が廃止されます。   |          |               |                 |   
      |      |        |                                  |          |               |                 |
      |      |        | `参考URL <https://github.blog/202|          |               |                 | 
      |      |        | 0-12-15-token-authentication-requ|          |               |                 |  
      |      |        | irements-for-git-operations/>`__ |          |               |                 |   
      |      |        |                                  |          |               |                 | 
      |      |        | パスワード認証が廃止され\        |          |               |                 |
      |      |        | ている GitHub を利用している場\  |          |               |                 |
      |      |        | 合、Git アカウント情報のパスワー\|          |               |                 |
      |      |        | ドには、自身で個人アクセストーク\|          |               |                 |
      |      |        | ンを作成し入力して下さい。       |          |               |                 |
      |      |        |                                  |          |               |                 |
      |      |        | `個人アクセストークン作成法 <http|          |               |                 |    
      |      |        | s://docs.github.com/ja/authentica|          |               |                 |
      |      |        | tion/keeping-your-account-and-dat|          |               |                 |
      |      |        | a-secure/creating-a-personal-acce|          |               |                 |
      |      |        | ss-token>`__                     |          |               |                 |
      +------+--------+----------------------------------+----------+---------------+-----------------+
      | ssh\ | パス\  | Git cloneコマンド実行時に求めら\ | ー       | 手動入力      | 最大長255バイト |
      | 接続\| ワード | れる Linux ユーザのパスワードを\ |          |               |                 |
      | 情報 |        | 入力して下さい。                 |          |               |                 | 
      |      |        |                                  |          |               |                 | 
      |      |        | プロトコルでsshパスワード認証を\ |          |               |                 |
      |      |        | 選択した場合、パスワードの入力\  |          |               |                 |
      |      |        | は必須です。                     |          |               |                 |
      |      +--------+----------------------------------+----------+---------------+-----------------+
      |      | パス\  | Git cloneコマンド実行時に求めら\ | ー       | 手動入力      | 最大長255バイト |
      |      | フレー\| れる鍵ファイルに設定されている\  |          |               |                 |
      |      | ズ     | パスフレーズを入力して下さい。   |          |               |                 |
      |      |        |                                  |          |               |                 |
      |      |        | プロトコルでssh鍵認証を選択した\ |          |               |                 |
      |      |        | 場合、パスフレーズの入力は必須\  |          |               |                 |
      |      |        | です。                           |          |               |                 |    
      |      +--------+----------------------------------+----------+---------------+-----------------+
      |      | 接続\  | Gitのcloneコマンドを実行時に\    | ー       | 手動入力      | 最大長4000バイト|
      |      | パラ\  | 環境変数「GIT_SSH_COMMANDに設定\ |          |               |                 |
      |      | メータ | するパラメータを入力します。     |          |               |                 |
      |      |        |                                  |          |               |                 |
      |      |        | GIT SSH COMMANDは、Git2.3以降\   |          |               |                 |
      |      |        | のバージョンで設定できる環境変数\|          |               |                 |
      |      |        | です。                           |          |               |                 |    
      |      |        | ITAサーバにインストールされてい\ |          |               |                 |
      |      |        | ているGitバージョンがGit2.3より\ |          |               |                 |
      |      |        | 古い場合は、設定されたパラメータ\|          |               |                 |
      |      |        | は無効になります。               |          |               |                 |
      |      |        |                                  |          |               |                 |  
      |      |        | 環境変数「GIT_SSH_COMMAND」は\   |          |               |                 |
      |      |        | デフォルトで下記のパラメータを設\|          |               |                 |
      |      |        | 定しています。                   |          |               |                 |
      |      |        | 設定されたパラメータはこの後ろに\|          |               |                 |
      |      |        | 追加されます。                   |          |               |                 |
      |      |        |                                  |          |               |                 |
      |      |        | UserKnownHostsFile=/dev/null -o \|          |               |                 |
      |      |        | StrictHostKeyChecking=no         |          |               |                 |
      |      |        |                                  |          |               |                 |       
      |      |        | また、git config-globalにcore.ss\|          |               |                 |
      |      |        | hCommandの設定が無い場合、下記の\|          |               |                 |
      |      |        | パラメータを設定します。         |          |               |                 |
      |      |        |                                  |          |               |                 |    
      |      |        | ssh –o UserKnownHostsFile=/dev/n\|          |               |                 |
      |      |        | ull -o StrictHostKeyChecking=no\ |          |               |                 |
      |      |        |                                  |          |               |                 |
      |      |        | git config –globalにcore.sshCom\ |          |               |                 | 
      |      |        | mand を設定している場合、下記の\ |          |               |                 |
      |      |        | パラメータを含めて下さい。       |          |               |                 |  
      |      |        |                                  |          |               |                 |
      |      |        | -o UserKnownHostsFile=/dev/null\ |          |               |                 |
      |      |        | -o StrictHostKeyChecking=no      |          |               |                 |
      +------+--------+----------------------------------+----------+---------------+-----------------+                   
      | Proxy| Address| プロキシサーバのアドレスを入力\  | ー       | 手動入力      | 最大長255バイト |
      |      |        | します。                         |          |               |                 |
      |      |        |                                  |          |               |                 |  
      |      |        | ITA がプロキシ環境下にある場合、\|          |               |                 |
      |      |        | Gitサーバまでの疎通のために設定\ |          |               |                 |  
      |      |        | が必要な場合があります。         |          |               |                 |    
      |      |        |                                  |          |               |                 | 
      |      |        | プロキシサーバの URL が `http://\|          |               |                 |   
      |      |        | procy.gate.co.jp:8080` の場合    |          |               |                 |
      |      |        |                                  |          |               |                 |
      |      |        | Address には `http://procy.gate.\|          |               |                 |  
      |      |        | co.jp` を入力します。            |          |               |                 |
      |      |        |                                  |          |               |                 |  
      |      |        | Port には 8080 を入力します。    |          |               |                 |     
      |      +--------+----------------------------------+----------+---------------+-----------------+
      |      | port   | プロキシサーバのポートを入力し\  | ー       | 手動入力      |                 |
      |      |        | ます。                           |          |               |                 |
      |      |        |                                  |          |               |                 |    
      |      |        | ITAがプロキシ環境下にある場合、  |          |               |                 |
      |      |        | Git サーバまでの疎通のために設定\|          |               |                 |
      |      |        | が必要な場合があります。         |          |               |                 |
      +------+--------+----------------------------------+----------+---------------+-----------------+
      | リ\  | 自動\  | Gitリポジトリとの同期を自動で\   | 〇       | リスト選択    | 初期値：有効    |
      | モ\  | 同期   | 行うかを選択して下さい。         |          |               |                 |
      | ー\  |        |                                  |          |               |                 |
      | ト\  |        | True：入力された周期で Gitリポジ\|          |               |                 |
      | リ\  |        | トリとの同期を行います。         |          |               |                 |
      | ポ\  |        |                                  |          |               |                 |
      | ジ\  |        | False:Gitリポジトリとの同期は\   |          |               |                 |
      | ト\  |        | 自動で行いません。               |          |               |                 |
      | リ\  +--------+----------------------------------+----------+---------------+-----------------+
      | 同\  | 周期\  | Git リポジトリとの同期を自動で\  | ー       | 手動入力      | 単位：秒        | 
      | 期\  | (秒)   | 行う周期を入力して下さい。       |          |               |                 |
      | 情\  |        |                                  |          |               |                 |     
      | 報\  |        | 未入力時のデフォルトは60秒です。 |          |               |                 | 
      +------+--------+----------------------------------+----------+---------------+-----------------+
      | 通\  | 回数   | Gitとの通信に失敗した場合、通信\ | ー       | 手動入力      |                 |
      | 信\  |        | をリトライする回数を入力して下さ\|          |               |                 |
      | リ\  |        | い。                             |          |               |                 |
      | ト\  |        | 未入力時のデフォルトは 3 回です。|          |               |                 |
      | ラ\  +--------+----------------------------------+----------+---------------+-----------------+
      | イ\  | 周期\  | Gitとの通信に失敗した場合、通信\ | ー       | 手動入力      | 単位：ms        |
      | 情\  | (ms)   | をリトライする間隔を入力して下さ\|          |               |                 |
      | 報   |        | い。                             |          |               |                 |  
      |      |        | 未入力時のデフォルトは1000msで\  |          |               |                 |             
      |      |        | す。                             |          |               |                 |
      +------+--------+----------------------------------+----------+---------------+-----------------+
      | 備考          | 自由記述\                        | ー       | 手動入力      | 最大長\         |         
      |               | 欄です。                         |          |               | 4000ﾊﾞｲﾄ        |          
      +---------------+----------------------------------+----------+---------------+-----------------+


3. | リモートリポジトリとの同期状態を表示する項目は以下の通りです。

   .. list-table:: リモートリポジトリ画面 同期状態表示項目一覧
      :widths: 5 20 5 
      :header-rows: 1
      :align: left
      
      * - 項目
        - 説明
        - 備考
      * - 状態
        - | Gitリポジトリとの同期状態を下記4つの状態で表示します。
          | 空白： レコードの新規登録・更新・廃止からの復活を行った状態
          | 正常： Git リポジトリとの同期が正常に行われている状態
          | 異常： Git リポジトリとの同期で異常が発生した状態
          | 再開： 再開ボタンをクリックした状態
          | 状態が異常になると、Git リポジトリとの同期が停止します。
          | 再開するには、再開ボタンをクリックするか、該当レコードを更新して下さい。
          | 「:ref:`cicd_for_iac_repository_register_notes`」を参照して下さい。
        - 
      * - 詳細情報
        - | 状態が異常になった場合、異常となった原因が表示されます。
          | 再開ボタンをクリックするか、該当レコードを更新すると詳細情報はクリアされます。
        - 
      * - 最終日時
        - | 最後に Git リポジトリと同期を行った日時が表示されます。
          | 再開ボタンをクリックするか、該当レコードを更新すると最終日時はクリアされます。
        - 
      * - 再開ボタン
        - | 状態が異常の場合にボタンが活性化します。
          | 再開ボタンをクリックすると状態が再開になります。 
        - 

.. _cicd_for_iac_file_link:

資材紐付
--------

1. | 「資材紐付」メニューでは、紐付元資材と紐付先資材を紐付し、紐付先資材の動作検証を行う為のオペレーションとMovementを登録します。
   | 紐付元資材が更新されると、内部機能で紐付先資材を自動更新し、動作検証を行う為のオペレーションとMovementで作業実行を行い、処理結果が表示されます。

.. figure:: /images/ja/cicd_for_iac/file_link_menu.png
   :width: 800px
   :alt: サブメニュー画面（資材紐付）

   サブメニュー画面（資材紐付）

2. | 資材紐付画面の入力項目は以下の通りです。

   .. table:: 資材紐付画面 入力項目一覧
      :widths: 8 8 8 25 12 12 12
      :align: left    

      +---------------+---------------------------------------------------+----------+---------------+-----------------+
      | **項目**      | **説明**                                          | **入力\  | **入\         | **制\           |          
      |               |                                                   | 必須**   | 力形式**      | 約事項**        |          
      +===============+===================================================+==========+===============+=================+
      | 紐付先資材名  | 紐付先資材に登録されている資材名\                 | 〇       | 手動入力      | 最大長255バイト | 
      |               | を入力してください。                              |          |               |                 |
      |               | この名前は、紐付先資材タイプに\                   |          |               |                 |       
      |               | より、下記メニューの項目に紐付け\                 |          |               |                 |
      |               | ます。                                            |          |               |                 |               
      |               | 各メニューの項目と同等の入力規則\                 |          |               |                 |    
      |               | があります。各項目の入力規則に\                   |          |               |                 |
      |               | 従い、資材名を入力してください。                  |          |               |                 |
      |               |                                                   |          |               |                 |
      |               | +----------------------+-------------------+      |          |               |                 |
      |               | | メニュー名           | 項目名            |      |          |               |                 |
      |               | +======================+===================+      |          |               |                 |
      |               | | Ansible-Legacy/Play\ | Paybook 素材名    |      |          |               |                 |    
      |               | | book 素材集          |                   |      |          |               |                 |
      |               | +----------------------+-------------------+      |          |               |                 |
      |               | | Ansible-Pioneer/対話\| 対象項目なし      |      |          |               |                 |
      |               | | ファイル素材集       |                   |      |          |               |                 |
      |               | +----------------------+-------------------+      |          |               |                 |
      |               | | Ansible-LegacyRole\  | ロールパッケージ名|      |          |               |                 |   
      |               | | /ロールパッケージ管理|                   |      |          |               |                 |
      |               | +----------------------+-------------------+      |          |               |                 |
      |               | | Ansible 共通/ファイ\ | ファイル埋込変数\ |      |          |               |                 |
      |               | | ル管理               | 名                |      |          |               |                 |
      |               | +----------------------+-------------------+      |          |               |                 |
      |               | | Ansible 共通/テンプ\ | ﾃﾝﾌﾟﾚｰﾄ埋込変数名 |      |          |               |                 |   
      |               | | レート管理           |                   |      |          |               |                 |
      |               | +----------------------+-------------------+      |          |               |                 |
      |               | | Terraform-Cloud-EP/\ | Module 素材名     |      |          |               |                 |
      |               | | Module素材集         |                   |      |          |               |                 |               
      |               | +----------------------+-------------------+      |          |               |                 |
      |               | | Terraform-Cloud-EP/\ | Policy 名         |      |          |               |                 |
      |               | | Policy 管理          |                   |      |          |               |                 |
      |               | +----------------------+-------------------+      |          |               |                 |
      |               | | Terraform-CLI/Module\| Module 素材名     |      |          |               |                 |      
      |               | | 素材集               |                   |      |          |               |                 |
      |               | +----------------------+-------------------+      |          |               |                 |
      |               |                                                   |          |               |                 |
      |               | 紐付先資材名に入力した資材名の登録有無等の条件に\ |          |               |                 | 
      |               | より紐付処理が異なります。                        |          |               |                 | 
      |               | 詳細は「4.紐付先資材の更新処理の流れ」\           |          |               |                 |
      |               | を参照してください。                              |          |               |                 |  
      |               |                                                   |          |               |                 | 
      |               | また、紐付先資材名を変更する場合「5.紐付先資材名\ |          |               |                 |    
      |               | を変更する場合の注意事項」\                       |          |               |                 |
      |               | を参照して下さい。                                |          |               |                 |
      +----+----------+---------------------------------------------------+----------+---------------+-----------------+ 
      | Gi\| 資材パス\| 「:ref:`cicd_for_iac_remote_repository`」メニュー\| 〇       | リスト選択    |                 |
      | t\ |          | に登録されているリモートリポジトリの資材パスが\   |          |               |                 | 
      | リ\|          | 一覧で表示されます。                              |          |               |                 |            
      | ポ\|          |                                                   |          |               |                 |
      | ジ\|          | 紐付先資材タイプが「Ansible-LegacyRole/ロールパッ\|          |               |                 |
      | ト\+          | ケージ管理」メニューの場合、「:ref:`cicd_for_iac\ |          |               |                 |
      | リ\|          | _role_package_notes`」を参照してください。        |          |               |                 |           
      | (F\|          |                                                   |          |               |                 | 
      | ro\|          |                                                   |          |               |                 |     
      | m) |          |                                                   |          |               |                 |    
      |    |          |                                                   |          |               |                 |
      +----+----------+---------------------------------------------------+----------+---------------+-----------------+
      | Ex\| 紐付先資\| 紐付先資材タイプ（メニュー）を選択して下さい。    | 〇       | リスト選択    |                 |
      | as\| 材タイプ | 紐付先資材は下記のメニューから選択できます。      |          |               |                 |
      | tr\|          | 各メニューを選択するには、各メニューに対応した\   |          |               |                 |  
      | o \|          | ドライバがインストールされている必要があります。  |          |               |                 |
      | IT\|          |                                                   |          |               |                 |
      | au\|          | +-------------------------+-------------------+   |          |               |                 |
      | tm\|          | | メニュー名              | インストールが必\ |   |          |               |                 |
      | at\|          | +=========================+===================+   |          |               |                 |
      | io\|          | | Ansible-Legacy/Playbook\| Ansible-Driver    |   |          |               |                 |  
      | n \|          | | 素材集                  |                   |   |          |               |                 |
      | (T\|          | +-------------------------+                   |   |          |               |                 |
      | o) |          | | Ansible-Pioneer/対話フ\ |                   |   |          |               |                 |
      |    |          | | ァイル素材集            |                   |   |          |               |                 |
      |    |          | +-------------------------+                   |   |          |               |                 |
      |    |          | | Ansible-LegacyRole/ロー\|                   |   |          |               |                 | 
      |    |          | | ルパッケージ管理        |                   |   |          |               |                 | 
      |    |          | +-------------------------+                   |   |          |               |                 |
      |    |          | | Ansible 共通/ファイル管\|                   |   |          |               |                 |  
      |    |          | | 理                      |                   |   |          |               |                 |
      |    |          | +-------------------------+                   |   |          |               |                 |
      |    |          | | Ansible 共通/テンプレー\|                   |   |          |               |                 |  
      |    |          | | ト管理                  |                   |   |          |               |                 |
      |    |          | +-------------------------+-------------------+   |          |               |                 |
      |    |          | | Terraform/Module 素材集 | Terraform-Cloud/\ |   |          |               |                 |
      |    |          | +-------------------------+ EP-Driver         |   |          |               |                 |
      |    |          | | Terraform/Policy 管理   |                   |   |          |               |                 |
      |    |          | +-------------------------+-------------------+   |          |               |                 |
      |    |          | | Terraform-CLI/Module\   | Terraform-CLI-Dri\|   |          |               |                 |  
      |    |          | | 素材集                  | ver               |   |          |               |                 |
      |    |          | +-------------------------+-------------------+   |          |               |                 |
      |    |          |                                                   |          |               |                 |
      |    +----+-----+---------------------------------------------------+----------+---------------+-----------------+    
      |    | テ\| 変\ | 紐付先資材タイプで「Ansible 共通/テンプレート管\  | ー       | 手動入力      | 最大長4000バイト|  
      |    | ン\| 数\ | 理」メニューを選択した場合、資材に必要な変数定義\ |          |               |                 |
      |    | プ\| 定\ | を入力して下さい。                                |          |               |                 | 
      |    | レ\| 義\ | 「Ansible 共通/テンプレート管理」メニュー以外を\  |          |               |                 | 
      |    | ー\|     | 選択している場合は入力不要です。                  |          |               |                 | 
      |    | ト\|     |                                                   |          |               |                 |  
      |    | 管\|     |                                                   |          |               |                 | 
      |    | 理 |     |                                                   |          |               |                 |
      |    +----+-----+---------------------------------------------------+----------+---------------+-----------------+
      |    | An\| 対\ | 「Ansible-Pioneer/対話種別」メニューに登録されて\ | ー       | リスト選択    |                 |
      |    | si\| 話\ | いる対話種別が一覧に表示されます。                |          |               |                 |
      |    | bl\| 種\ | 紐付先資材タイプで「Ansible-Pioneer/対話ファイル\ |          |               |                 |  
      |    | e-\| 別  | 素材集」メニューを選択した場合、紐付先資材の対話\ |          |               |                 | 
      |    | Pi\|     | 種別を一覧より選択して下さい。                    |          |               |                 | 
      |    | on\|     | 紐付先資材タイプで「Ansible-Pioneer/対話ファイル\ |          |               |                 |
      |    | eer|     | 素材集」メニュー以外を選択している場合は選択不要\ |          |               |                 |
      |    |    |     | です。                                            |          |               |                 |
      |    |    +-----+---------------------------------------------------+----------+---------------+-----------------+
      |    |    | OS\ | 「Ansible-Pioneer/OS 種別」メニューに登録されてい\| ー       | リスト選択    |                 |
      |    |    | 種別| るOS種別が一覧に表示されます。                    |          |               |                 |
      |    |    |     | 紐付先資材タイプで「Ansible-Pioneer/対話ファイル\ |          |               |                 |
      |    |    |     | 素材集」メニューを選択した場合、紐付先資材のOS種\ |          |               |                 |
      |    |    |     | 別を一覧より選択して下さい。                      |          |               |                 |
      |    |    |     | 紐付先資材タイプで「Ansible-Pioneer/対話ファイル\ |          |               |                 |
      |    |    |     | 素材集」メニュー以外を選択している場合は選択不要\ |          |               |                 |
      |    |    |     | です。                                            |          |               |                 |
      +----+----+-----+---------------------------------------------------+----------+---------------+-----------------+
      | 素\| 自動同期 | Git リポジトリの資材が更新された場合に紐付先資材\ | 〇       | リスト選択    | 初期値：有効    |
      | 材\|          | の更新を自動で行うかを選択して下さい。            |          |               |                 |
      | 同\|          |                                                   |          |               |                 | 
      | 期\|          | True：Git リポジトリの資材が更新された場合、紐付\ |          |               |                 |
      | 情\|          | 先資材の更新を自動で行います。                    |          |               |                 |
      | 報 |          |                                                   |          |               |                 |
      |    |          | False：Git リポジトリの資材が更新されても紐付先資\|          |               |                 |
      |    |          | 材の更新を行いません。                            |          |               |                 |
      +----+----------+---------------------------------------------------+----------+---------------+-----------------+
      | デ\| オペレー\| 「基本コンソール/投入オペレーション一覧」メニュー\| ー       | リスト選択    |                 |
      | リ\| ション   | に登録されているオペレーションの一覧が表示されま\ |          |               |                 | 
      | バ\|          | す。                                              |          |               |                 | 
      | リ\|          |                                                   |          |               |                 |
      | 情\|          | 紐付先資材を更新した場合に、Movemnet を実行するオ\|          |               |                 | 
      | 報 |          | ペレーションを選択します。                        |          |               |                 |
      |    +----------+---------------------------------------------------+----------+---------------+-----------------+
      |    | Movement | 「基本コンソール/Movement一覧」メニューに登録さ\  | ー       | リスト選択    |                 |
      |    |          | れているMovement の一覧が表示されます。           |          |               |                 |
      |    |          |                                                   |          |               |                 |
      |    |          | 紐付先資材を更新した場合に、実行するMovementを選\ |          |               |                 |
      |    |          | 択します。                                        |          |               |                 |
      |    +----------+---------------------------------------------------+----------+---------------+-----------------+
      |    | ドライラ\| Movement を実行するモードを選択します。           | ー       | リスト選択    |                 |     
      |    | ン       |                                                   |          |               |                 |
      |    |          | True:を選択した場合、ドライランモード（Ansible\   |          |               |                 |
      |    |          | ドライバの場合はドライラン、Terraformドライバ\    |          |               |                 | 
      |    |          | の場合はPlan確認）でMovementを実行します。        |          |               |                 |
      |    |          |                                                   |          |               |                 |
      |    |          | Falseもしくは未選択時はドライランモードでは\      |          |               |                 |
      |    |          | 実行しません。                                    |          |               |                 |
      +----+----------+---------------------------------------------------+----------+---------------+-----------------+  
      | 備考          | 自由記述欄です。                                  | ー       | 手動入力      | 最大長4000バイト|
      +---------------+---------------------------------------------------+----------+---------------+-----------------+                                              


3. | Gitリポジトリの資材と紐付先資材との同期の状態を表示する項目は以下の通りです。
  
   .. table:: 資材紐付画面 状態表示項目一覧
      :widths: 1 2 6 1
      :align: left

      +-------------------------+---------------------------------------------------+-------------+
      | **項目**                | **説明**                                          | **備考**    |       
      +======+==================+===================================================+=============+
      | 資材\| 状態             | 紐付元資材と紐付先資材の同期状態を下記4つの状態で\|             |
      | 同期\|                  | 表示します。                                      |             |      
      | 情報 |                  |                                                   |             | 
      |      |                  | 空白： レコードの新規登録・更新・廃止からの復活を\|             |
      |      |                  | 行った状態。                                      |             |
      |      |                  |                                                   |             |
      |      |                  | 正常： 紐付元資材と紐付先資材の同期が正常に行われ\|             |
      |      |                  | ている状態                                        |             |
      |      |                  |                                                   |             |
      |      |                  | 異常： 以下の2通りの状態が考えられます。          |             |
      |      |                  |                                                   |             |  
      |      |                  | ・紐付元資材と紐付先資材の同期で異常が発生した状\ |             |
      |      |                  | 態                                                |             |
      |      |                  |                                                   |             |
      |      |                  | ・紐付先資材の更新により、設定されているオペレー\ |             |
      |      |                  | ションとMovementで作業実行をしたが作業実行が出来\ |             | 
      |      |                  | なかった状態※1                                    |             |
      |      |                  |                                                   |             |
      |      |                  | 再開： 再開ボタンをクリックした状態               |             |
      |      |                  |                                                   |             |
      |      |                  | 状態が異常になると、紐付元資材と紐付先資材の同期\ |             |
      |      |                  | が停止します。再開するには、再開ボタンをクリック\ |             |
      |      |                  | するか、該当レコードを更新して下さい。            |             |
      |      +------------------+---------------------------------------------------+-------------+         
      |      | 詳細情報         | 紐付元資材と紐付先資材の同期状態が異常になった場\ |             |
      |      |                  | 合、異常となった原因が表示されます。              |             |
      |      |                  |                                                   |             |  
      |      |                  | 再開ボタンをクリックするか、該当レコードを更新す\ |             |
      |      |                  | ると詳細情報はクリアされます。                    |             |
      |      +------------------+---------------------------------------------------+-------------+
      |      | 最終日時         | 最後に紐付元資材と紐付先資材の同期を行った日時が\ |             |
      |      |                  | 表示されます。                                    |             |
      |      |                  |                                                   |             |    
      |      |                  | 再開ボタンをクリックするか、該当レコードを更新す\ |             |
      |      |                  | ると最終日時はクリアされます。                    |             |
      |      +------------------+---------------------------------------------------+-------------+
      |      | 再開ボタン       | 状態が異常の場合にボタンが活性します。            |             |
      |      |                  |                                                   |             |
      |      |                  | 再開ボタンをクリックすると状態が再開になります。  |             |
      +------+------------------+---------------------------------------------------+-------------+ 
      | デリ\| 詳細情報         | 紐付先資材の更新により、設定されているオペレーシ\ |             |
      | バリ\|                  | ョンと Movement で作業実行をしたが作業実行が出来\ |             |
      | 情報 |                  | なかった場合、実行出来なかったエラー原因が表示さ\ |             |
      |      |                  | れます。※1                                        |             |
      |      |                  |                                                   |             |
      |      |                  | 尚、作業実行が実行できた場合、実行結果が異常かど\ |             |
      |      |                  | うかの判定※2 はしていません。                     |             |
      |      |                  | 作業状態確認ボタンをクリックし「各ドライバ/作業状\|             |
      |      |                  | 態確認」メニューより実行結果を確認して下さい。    |             |
      |      |                  |                                                   |             |
      |      |                  | 再開ボタンをクリックするか、該当レコードを更新す\ |             |
      |      |                  | ると詳細情報はクリアされます。                    |             |
      |      +------------------+---------------------------------------------------+-------------+
      |      | 作業インスンスNo | オペレーションと Movement で作業実行が実行できた\ |             |
      |      |                  | 場合、作業実行の作業インスタンス No が表示されま\ |             |
      |      |                  | す。                                              |             | 
      |      |                  |                                                   |             |
      |      |                  | 再開ボタンをクリックするか、該当レコードを更新す\ |             |
      |      |                  | ると作業インスタンス No はクリアされます。        |             |
      |      +------------------+---------------------------------------------------+-------------+   
      |      | 作業状態確認\    | オペレーションと Movement で作業実行が実行できた\ |             |
      |      | ボタン           | 場合、作業状態確認ボタンが活性します。            |             |
      |      |                  |                                                   |             |
      |      |                  | 作業状態確認ボタンをクリックすると、「各ドライバ/\|             | 
      |      |                  | 作業状態確認」メニューが表示され、作業実行の状態\ |             |
      |      |                  | を確認する事が出来ます。                          |             |
      |      |                  |                                                   |             |
      |      |                  | 「作業状態確認」の詳細については各ドライバの\     |             |
      |      |                  | 「利用手順マニュアル」を参照してください。        |             | 
      |      |                  |                                                   |             |
      |      |                  | 再開ボタンをクリックするか、該当レコードを更新す\ |             |
      |      |                  | ると作業状態確認ボタンは非活性になります。        |             |
      +------+------------------+---------------------------------------------------+-------------+



| ※1 オペレーションやMovementが廃止されている場合など。
| ※2 紐付先資材に誤りがあった場合や、作業実行に必要な情報が不足している場合など。

.. _cicd_for_iac_link_file_upload_flow:

4. | 紐付先資材の更新処理の流れ

   .. image:: /images/ja/cicd_for_iac/CICD_flow2.png
      :width: 600px

| ※1 紐付先資材タイプが「Ansible-Pioneer/対話ファイル素材集」の場合、紐付先資材名は対話種別とOS種別の組み合わせになります。
| ※2 作業実行に必要な情報が不足している場合、作業実行が失敗する場合があります。
| ※3 項目の差分は備考も含まれます。また、備考については常に空白で更新されます。
| ※4 「:ref:`cicd_for_iac_file_link`」メニューの「資材同期情報/状態」項目に「異常」を、「資材同期情報/詳細情報」項目にエラー原因を設定します。
| ※5 「:ref:`cicd_for_iac_file_link`」メニューの「資材同期情報/状態」項目に「異常」を、「デリバリ情報/詳細情報」項目にエラー原因を設定します。
| ※6 「:ref:`cicd_for_iac_file_link`」メニューの「資材同期情報/状態」項目に「正常」を設定します。

.. _cicd_for_iac_file_link_change_name:

1. | 紐付先資材名を変更する場合の注意事項
   | 紐付先資材名を変更した場合、紐付先資材の変更前のレコードはそのまま残り、変更後の紐付先資材名で新しいレコードが作成されます。


CI/CD For IaC 非表示メニュー
============================

| 本節では、CI/CD For IaC機能をインストールした状態では表示されないメニューの操作について記載します。
| 各メニューにアクセスするには、「管理コンソール/ロール・メニュー紐付管理」で各メニューを復活処理を行うことによって表示されるようになります。


リモートリポジトリ資材
----------------------

1. | 「リモートリポジトリ資材」メニューには、紐付元資材の一覧が表示されます。
    
   | 「リモートリポジトリ資材」メニューに表示される情報は内部機能で更新しています。
   | レコード追加・更新・削除は行わないで下さい。


.. figure:: /images/ja/cicd_for_iac/remote_repository_file_menu.png
   :width: 800px
   :alt: サブメニュー画面（リモートリポジトリ資材）

   サブメニュー画面（リモートリポジトリ資材）


2. | リモートリポジトリ資材画面の表示項目は以下の通りです。

   .. table:: リモートリポジトリ資材画面 項目一覧

      +---------------+---------------+--------+------------+---------------+
      | **項目**      | **説明**      | **入力\| **入力\    | **制約事項**  |
      |               |               | 必須** | 形式**     |               |
      +===============+===============+========+============+===============+
      | リモート\     | 「:ref:`cicd\ | ○      | リスト選択 |               |
      | リポジトリ名  | _for_iac_remo\|        |            |               |
      |               | te_repositor\ |        |            |               |
      |               | y`」メニュ\   |        |            |               |
      |               | ーで登録した\ |        |            |               |
      |               | リモートリポ\ |        |            |               |
      |               | ジトリ名が表\ |        |            |               |
      |               | 示されます。  |        |            |               |
      +---------------+---------------+--------+------------+---------------+
      | 資材パス      | 紐付元資材の\ | ○      | 手動入力   | 最\           |
      |               | 資材パスが表\ |        |            | 大長4096ﾊﾞｲﾄ  |
      |               | 示されます。  |        |            |               |
      |               |               |        |            |               | 
      |               | 「:ref:`cicd\ |        |            |               |
      |               | _for_iac_remo\|        |            |               |
      |               | te_repositor\ |        |            |               |
      |               | y`」メニュー\ |        |            |               |
      |               | の\           |        |            |               |
      |               | 「同期状態」\ |        |            |               |
      |               | が「異常」が\ |        |            |               |
      |               | 設定されてい\ |        |            |               |
      |               | るリモートリ\ |        |            |               |
      |               | ポジトリの資\ |        |            |               |
      |               | 材パスは表示\ |        |            |               |
      |               | されません。  |        |            |               |
      +---------------+---------------+--------+------------+---------------+
      | 資材タイプ    | 対象が\       | ○      | リスト選択 |               |
      |               | Ansible-Legac\|        |            |               |
      |               | yRoleの資材の\|        |            |               |
      |               | 場合は「Roles\|        |            |               |
      |               | ディレクトリ\ |        |            |               |
      |               | 」が、それ以\ |        |            |               |
      |               | 外では「ファ\ |        |            |               |
      |               | イル」が入り\ |        |            |               |
      |               | ます。        |        |            |               |
      |               |               |        |            |               |
      +---------------+---------------+--------+------------+---------------+

付録
****

.. _cicd_for_iac_repository_register_notes:

資材をGitリポジトリに登録する場合の注意事項
===========================================

| 資材をGitリポジトリに登録する場合の注意事項を以下に記述します。

#. | 256バイト以上の資材名が含まれるGitリポジトリを「:ref:`cicd_for_iac_remote_repository`」メニューに登録すると、Git clone commandが異常終了します。

#. | ファイルパスも含めて4096バイト以上の資材名が含まれるGitリポジトリを「:ref:`cicd_for_iac_remote_repository`」メニューに登録すると、Git clone commandが異常終了します。


.. _cicd_for_iac_role_package_notes:

ロールパッケージ管理に紐付する資材をGitリポジトリに登録する場合の注意事項
=========================================================================

| 「Ansible-LegacyRole/ロールパッケージ管理」メニューに紐付する資材をGitリポジトリに登録する場合の注意事項を以下に記述します。

#. | rolesという名前のディレクトリを含むディレクトリを作成し、この配下にロールパッケージに必要なファイル・ディレクトリを配置して下さい。
   | ロールパッケージとしてzipで固められる資材は、rolesディレクトリの上位ディレクトリ配下になります。ただし、Gitリポジトリのルートディレクトリ直下にrolesという名前のディレクトリを作成しても、「Ansible-LegacyRole/ロールパッケージ管理」メニューに紐付するrolesディレクトリとして認識しません。

   | 
   | 以下のようなファイル・ディレクトリ構成の場合、「sample/roles」はrolesディレクトリとして認識しますが、「roles」はrolesディレクトリとして認識しません。

   | Gitリポジトリのルートディレクトリ


   .. code-block:: bash
     :caption: Gitリポジトリのルートディレクトリ

     |-  roles          ・・・・・・・roles ディレクトリとして認識しません。
     |   |  ita_readme_test_role.yml
     |   |- test_role
     |      |-  defaults
     |      |     main.yml
     |      |-  tasks
     |            main.yml
     |
     |- sample
         | ita_readme_test_role.yml
         |- roles       ・・・・・・・roles ディレクトリとして認識します。
             |- test_role
                |- defaults
                |     main.yml
                |- tasks
                      main.yml

  
                            
| 「:ref:`cicd_for_iac_file_link`」メニューの資材パスに「sample/roles」が表示されます。「Ansible-LegacyRole/ロールパッケージ管理」メニューに紐付ける資材パスには、「sample/roles」を選択して下さい。

.. figure:: /images/ja/cicd_for_iac/sample_roles.png
   :width: 800px
   :alt: sample_role
